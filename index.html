<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°œë¯¸ ë°±í…ŒìŠ¤íŠ¸ PRO</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-1: #00c6ff;
      --bg-2: #ffdde1;
      --card-bg: rgba(255, 255, 255, 0.92);
      --text: #111827;
      --muted: #4b5563;
      --btn: #111827;
      --btn-hover: #1f2937;
      --line: rgba(0, 0, 0, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 24px 16px 40px;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      background: var(--card-bg);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin: 0 0 16px;
      text-align: center;
      font-size: 28px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .tabs button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      background: #f3f4f6;
      color: #111827;
      font-weight: 700;
      cursor: pointer;
    }

    .tabs button.active-tab {
      background: var(--btn);
      color: white;
    }

    .page { display: none; }
    .page.active { display: block; }

    .panel-title {
      font-size: 20px;
      margin: 4px 0 12px;
      text-align: center;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .form-grid input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: #111827;
    }

    .run-row {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }

    .run-row button {
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      background: var(--btn);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .run-row button:hover { background: var(--btn-hover); }

    .hint {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 10px;
    }

    .result {
      text-align: center;
      font-weight: 700;
      margin: 10px 0 8px;
      min-height: 24px;
    }

    .chart-wrap {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: white;
    }

    canvas {
      width: 100%;
      max-height: 420px;
    }

    @media (max-width: 700px) {
      .form-grid { grid-template-columns: 1fr; }
      h1 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ê°œë¯¸ ë°±í…ŒìŠ¤íŠ¸ PRO</h1>

    <div class="tabs">
      <button id="tab-us" class="active-tab" onclick="showPage('us')">ğŸ‡ºğŸ‡¸ ì„œí•™ê°œë¯¸</button>
      <button id="tab-kr" onclick="showPage('kr')">ğŸ‡°ğŸ‡· ë™í•™ê°œë¯¸</button>
    </div>

    <section id="us" class="page active">
      <h2 class="panel-title">S&P500 ë¹„êµ (USD)</h2>
      <div class="form-grid">
        <input id="usTicker" placeholder="ì¢…ëª© ì½”ë“œ (ì˜ˆ: AAPL)">
        <input type="month" id="usStart">
        <input type="number" id="usMoney" placeholder="ì´ˆê¸° íˆ¬ìê¸ˆ">
        <input type="number" id="usMonthly" placeholder="ì›” ì ë¦½ê¸ˆ (ì„ íƒ)">
      </div>
      <div class="run-row">
        <button onclick="runBacktest('us')">ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      </div>
      <p class="hint">ì§€ìˆ˜ ë¹„êµ: S&amp;P500</p>
      <p id="usResult" class="result"></p>
      <div class="chart-wrap">
        <canvas id="usChart"></canvas>
      </div>
    </section>

    <section id="kr" class="page">
      <h2 class="panel-title">KOSPI ë¹„êµ (KRW)</h2>
      <div class="form-grid">
        <input id="krTicker" placeholder="ì¢…ëª© ì½”ë“œ/íšŒì‚¬ëª… (ì˜ˆ: 005930.KS ë˜ëŠ” ì‚¼ì„±ì „ì)">
        <input type="month" id="krStart">
        <input type="number" id="krMoney" placeholder="ì´ˆê¸° íˆ¬ìê¸ˆ">
        <input type="number" id="krMonthly" placeholder="ì›” ì ë¦½ê¸ˆ (ì„ íƒ)">
      </div>
      <div class="run-row">
        <button onclick="runBacktest('kr')">ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      </div>
      <p class="hint">ì§€ìˆ˜ ë¹„êµ: KOSPI / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì‚¼ì„±ì „ì, LGì „ì)</p>
      <p id="krResult" class="result"></p>
      <div class="chart-wrap">
        <canvas id="krChart"></canvas>
      </div>
    </section>
  </div>

  <script>
    const WORKER_URL = "https://stock-backtesting-gmc.pages.dev";
    const API_ENDPOINTS = ["/api/chart", `${WORKER_URL}/api/chart`].filter(Boolean);
    const charts = {};

    function showPage(id) {
      document.querySelectorAll(".page").forEach((page) => page.classList.remove("active"));
      document.querySelectorAll(".tabs button").forEach((btn) => btn.classList.remove("active-tab"));
      document.getElementById(id).classList.add("active");
      document.getElementById(`tab-${id}`).classList.add("active-tab");
    }

    async function fetchData(symbol, startDate, market) {
      const from = Math.floor(new Date(startDate + "-01").getTime() / 1000);
      const to = Math.floor(Date.now() / 1000);
      const qs = `symbol=${encodeURIComponent(symbol)}&from=${from}&to=${to}&market=${encodeURIComponent(market)}`;
      let lastError = "API í˜¸ì¶œ ì‹¤íŒ¨";

      for (const endpoint of API_ENDPOINTS) {
        const url = endpoint.includes("?") ? `${endpoint}&${qs}` : `${endpoint}?${qs}`;
        try {
          const res = await fetch(url);
          const body = await res.text();
          if (!res.ok) {
            lastError = `ì‘ë‹µ ì˜¤ë¥˜(${res.status}): ${body.slice(0, 120)}`;
            continue;
          }

          const contentType = (res.headers.get("content-type") || "").toLowerCase();
          if (!contentType.includes("application/json")) {
            lastError = `JSON ì•„ë‹˜: ${body.slice(0, 120)}`;
            continue;
          }

          const trimmed = body.trim();
          if (!(trimmed.startsWith("{") || trimmed.startsWith("["))) {
            lastError = `JSON í˜•ì‹ ì•„ë‹˜: ${trimmed.slice(0, 120)}`;
            continue;
          }

          let json;
          try {
            json = JSON.parse(trimmed);
          } catch (_e) {
            lastError = `JSON íŒŒì‹± ì‹¤íŒ¨: ${trimmed.slice(0, 120)}`;
            continue;
          }

          const result = json?.chart?.result?.[0];
          if (result) return result;
          lastError = "ìœ íš¨í•œ ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ";
        } catch (error) {
          lastError = String(error);
        }
      }

      throw new Error(lastError);
    }

    function toFixed2(value) {
      return Number(value).toLocaleString("ko-KR", { maximumFractionDigits: 2 });
    }

    async function runBacktest(type) {
      const ticker = document.getElementById(type + "Ticker").value.trim();
      const start = document.getElementById(type + "Start").value;
      const money = parseFloat(document.getElementById(type + "Money").value);
      const monthly = parseFloat(document.getElementById(type + "Monthly").value || "0");
      const resultEl = document.getElementById(type + "Result");

      if (!ticker || !start || !money || money <= 0) {
        alert("ì¢…ëª©, ì‹œì‘ì›”, ì´ˆê¸° íˆ¬ìê¸ˆì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      try {
        resultEl.textContent = "ê³„ì‚° ì¤‘...";

        const stock = await fetchData(ticker, start, type);
        const indexTicker = type === "us" ? "^GSPC" : "^KS11";
        const indexLabel = type === "us" ? "S&P500" : "KOSPI";
        const index = await fetchData(indexTicker, start, type);
        const stockSymbol = stock?.meta?.symbol || ticker.toUpperCase();

        const stockPrices = stock?.indicators?.adjclose?.[0]?.adjclose || [];
        const indexPrices = index?.indicators?.adjclose?.[0]?.adjclose || [];
        const stockTs = stock?.timestamp || [];
        const indexTs = index?.timestamp || [];

        const indexMap = new Map();
        indexTs.forEach((t, i) => {
          const p = indexPrices[i];
          if (p != null) indexMap.set(t, p);
        });

        let shares = 0;
        let indexShares = 0;
        const labels = [];
        const stockValue = [];
        const indexValue = [];

        stockTs.forEach((ts, i) => {
          const p = stockPrices[i];
          const ip = indexMap.get(ts);
          if (p == null || ip == null) return;

          if (labels.length === 0) {
            shares += money / p;
            indexShares += money / ip;
          }
          if (monthly > 0) {
            shares += monthly / p;
            indexShares += monthly / ip;
          }

          labels.push(new Date(ts * 1000).toLocaleDateString("ko-KR"));
          stockValue.push(shares * p);
          indexValue.push(indexShares * ip);
        });

        if (labels.length === 0) {
          throw new Error("ê²¹ì¹˜ëŠ” ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        if (charts[type]) {
          charts[type].destroy();
        }

        const ctx = document.getElementById(type + "Chart");
        charts[type] = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: stockSymbol,
                data: stockValue,
                borderWidth: 2,
                tension: 0.2
              },
              {
                label: indexLabel,
                data: indexValue,
                borderWidth: 2,
                tension: 0.2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { position: "bottom" }
            }
          }
        });

        const lastStock = stockValue[stockValue.length - 1];
        const lastIndex = indexValue[indexValue.length - 1];
        const winner = lastStock >= lastIndex ? stockSymbol : indexLabel;
        resultEl.textContent = `ìµœì¢… í‰ê°€ê¸ˆ: ${stockSymbol} ${toFixed2(lastStock)} / ${indexLabel} ${toFixed2(lastIndex)} (ìš°ì„¸: ${winner})`;
      } catch (error) {
        console.error(error);
        resultEl.textContent = "";
        alert(`ë°±í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
      }
    }
  </script>
</body>
</html>
