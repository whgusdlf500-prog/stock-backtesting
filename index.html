<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°œë¯¸ ë°±í…ŒìŠ¤íŠ¸ PRO</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-1: #00c6ff;
      --bg-2: #ffdde1;
      --card-bg: rgba(255, 255, 255, 0.93);
      --text: #111827;
      --muted: #4b5563;
      --btn: #111827;
      --btn-hover: #1f2937;
      --line: rgba(0, 0, 0, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 24px 16px 40px;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      background: var(--card-bg);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    h1 {
      margin: 0;
      font-size: 28px;
    }

    .lang-switch {
      display: flex;
      gap: 6px;
    }

    .lang-switch button {
      border: 1px solid #d1d5db;
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 700;
      cursor: pointer;
    }

    .lang-switch button.active-lang {
      background: var(--btn);
      color: #fff;
      border-color: var(--btn);
    }

    .tabs {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .tabs button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      background: #f3f4f6;
      color: #111827;
      font-weight: 700;
      cursor: pointer;
    }

    .tabs button.active-tab {
      background: var(--btn);
      color: white;
    }

    .page { display: none; }
    .page.active { display: block; }

    .panel-title {
      font-size: 20px;
      margin: 4px 0 12px;
      text-align: center;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .form-grid input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: #111827;
    }

    .run-row {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }

    .run-row button {
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      background: var(--btn);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .run-row button:hover { background: var(--btn-hover); }

    .hint {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 10px;
    }

    .result {
      text-align: center;
      font-weight: 700;
      margin: 10px 0 8px;
      min-height: 24px;
      line-height: 1.45;
    }

    .chart-wrap {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: white;
    }

    canvas {
      width: 100%;
      max-height: 420px;
    }

    @media (max-width: 700px) {
      .form-grid { grid-template-columns: 1fr; }
      h1 { font-size: 24px; }
      .top-row { justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-row">
      <h1 id="titleText">ê°œë¯¸ ë°±í…ŒìŠ¤íŠ¸ PRO</h1>
      <div class="lang-switch">
        <button id="lang-ko" class="active-lang" onclick="setLanguage('ko')">í•œêµ­ì–´</button>
        <button id="lang-en" onclick="setLanguage('en')">English</button>
      </div>
    </div>

    <div class="tabs">
      <button id="tab-us" class="active-tab" onclick="showPage('us')">ğŸ‡ºğŸ‡¸ <span id="tabUsText">ì„œí•™ê°œë¯¸</span></button>
      <button id="tab-kr" onclick="showPage('kr')">ğŸ‡°ğŸ‡· <span id="tabKrText">ë™í•™ê°œë¯¸</span></button>
    </div>

    <section id="us" class="page active">
      <h2 id="usPanelTitle" class="panel-title">S&amp;P500 ë¹„êµ (USD)</h2>
      <div class="form-grid">
        <input id="usTicker" placeholder="í‹°ì»¤/íšŒì‚¬ëª… (ì˜ˆ: AAPL, ì• í”Œ)">
        <input id="usCompare1" placeholder="ë¹„êµ íšŒì‚¬ 1 (ì„ íƒ)">
        <input id="usCompare2" placeholder="ë¹„êµ íšŒì‚¬ 2 (ì„ íƒ)">
        <input type="month" id="usStart">
        <input type="number" id="usMoney" placeholder="ì´ˆê¸° íˆ¬ìê¸ˆ">
        <input type="number" id="usMonthly" placeholder="ì›” ì ë¦½ê¸ˆ (ì„ íƒ)">
      </div>
      <div class="run-row">
        <button id="runUsBtn" onclick="runBacktest('us')">ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      </div>
      <p id="usHint" class="hint">ì§€ìˆ˜ ë¹„êµ: S&amp;P500 / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì• í”Œ, ë§ˆì´í¬ë¡œì†Œí”„íŠ¸)</p>
      <p id="usResult" class="result"></p>
      <div class="chart-wrap">
        <canvas id="usChart"></canvas>
      </div>
    </section>

    <section id="kr" class="page">
      <h2 id="krPanelTitle" class="panel-title">KOSPI ë¹„êµ (KRW)</h2>
      <div class="form-grid">
        <input id="krTicker" placeholder="ì¢…ëª©ì½”ë“œ/íšŒì‚¬ëª… (ì˜ˆ: 005930.KS, ì‚¼ì„±ì „ì)">
        <input id="krCompare1" placeholder="ë¹„êµ íšŒì‚¬ 1 (ì„ íƒ)">
        <input id="krCompare2" placeholder="ë¹„êµ íšŒì‚¬ 2 (ì„ íƒ)">
        <input type="month" id="krStart">
        <input type="number" id="krMoney" placeholder="ì´ˆê¸° íˆ¬ìê¸ˆ">
        <input type="number" id="krMonthly" placeholder="ì›” ì ë¦½ê¸ˆ (ì„ íƒ)">
      </div>
      <div class="run-row">
        <button id="runKrBtn" onclick="runBacktest('kr')">ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      </div>
      <p id="krHint" class="hint">ì§€ìˆ˜ ë¹„êµ: KOSPI / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì‚¼ì„±ì „ì, LGì „ì)</p>
      <p id="krResult" class="result"></p>
      <div class="chart-wrap">
        <canvas id="krChart"></canvas>
      </div>
    </section>
  </div>

  <script>
    const WORKER_URL = "https://stock-backtesting-gmc.pages.dev";
    const API_ENDPOINTS = ["/api/chart", `${WORKER_URL}/api/chart`].filter(Boolean);
    const MAPPING_JSON_URL = "/company-mappings.json";
    const charts = {};
    const chartTimers = {};
    let currentLang = "ko";
    let companyLabelsBySymbol = {};

    const I18N = {
      ko: {
        title: "ê°œë¯¸ ë°±í…ŒìŠ¤íŠ¸ PRO",
        tabUs: "ì„œí•™ê°œë¯¸",
        tabKr: "ë™í•™ê°œë¯¸",
        usPanel: "S&P500 ë¹„êµ (USD)",
        krPanel: "KOSPI ë¹„êµ (KRW)",
        usHint: "ì§€ìˆ˜ ë¹„êµ: S&P500 / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì• í”Œ, ë§ˆì´í¬ë¡œì†Œí”„íŠ¸)",
        krHint: "ì§€ìˆ˜ ë¹„êµ: KOSPI / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì‚¼ì„±ì „ì, LGì „ì)",
        run: "ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰",
        usTicker: "í‹°ì»¤/íšŒì‚¬ëª… (ì˜ˆ: AAPL, ì• í”Œ)",
        krTicker: "ì¢…ëª©ì½”ë“œ/íšŒì‚¬ëª… (ì˜ˆ: 005930.KS, ì‚¼ì„±ì „ì)",
        compare1: "ë¹„êµ íšŒì‚¬ 1 (ì„ íƒ)",
        compare2: "ë¹„êµ íšŒì‚¬ 2 (ì„ íƒ)",
        startMoney: "ì´ˆê¸° íˆ¬ìê¸ˆ",
        monthly: "ì›” ì ë¦½ê¸ˆ (ì„ íƒ)",
        alertInput: "ì¢…ëª©, ì‹œì‘ì›”, ì´ˆê¸° íˆ¬ìê¸ˆì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.",
        loading: "ê³„ì‚° ì¤‘...",
        indexUs: "S&P500",
        indexKr: "KOSPI",
        winner: "ìš°ì„¸",
        resultPrefix: "ìµœì¢… í‰ê°€ê¸ˆ",
        principalPrefix: "ì›ê¸ˆ",
        returnPrefix: "ìˆ˜ìµë¥ ",
        errorPrefix: "ë°±í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"
      },
      en: {
        title: "Ant Backtest PRO",
        tabUs: "US Stocks",
        tabKr: "Korean Stocks",
        usPanel: "S&P500 Comparison (USD)",
        krPanel: "KOSPI Comparison (KRW)",
        usHint: "Benchmark: S&P500 / Korean names allowed (e.g., ì• í”Œ, ë§ˆì´í¬ë¡œì†Œí”„íŠ¸)",
        krHint: "Benchmark: KOSPI / Korean names allowed (e.g., ì‚¼ì„±ì „ì, LGì „ì)",
        run: "Run Backtest",
        usTicker: "Ticker/Company (e.g., AAPL, ì• í”Œ)",
        krTicker: "Ticker/Company (e.g., 005930.KS, ì‚¼ì„±ì „ì)",
        compare1: "Compare company 1 (optional)",
        compare2: "Compare company 2 (optional)",
        startMoney: "Initial investment",
        monthly: "Monthly contribution (optional)",
        alertInput: "Please enter a valid symbol, start month, and initial investment.",
        loading: "Calculating...",
        indexUs: "S&P500",
        indexKr: "KOSPI",
        winner: "Winner",
        resultPrefix: "Final value",
        principalPrefix: "Principal",
        returnPrefix: "Return",
        errorPrefix: "Backtest failed"
      }
    };

    const COMPANY_LABELS = {
      "005930.KS": { ko: "ì‚¼ì„±ì „ì", en: "Samsung Electronics" },
      "066570.KS": { ko: "LGì „ì", en: "LG Electronics" },
      "000660.KS": { ko: "SKí•˜ì´ë‹‰ìŠ¤", en: "SK hynix" },
      "373220.KS": { ko: "LGì—ë„ˆì§€ì†”ë£¨ì…˜", en: "LG Energy Solution" },
      "005380.KS": { ko: "í˜„ëŒ€ì°¨", en: "Hyundai Motor" },
      "000270.KS": { ko: "ê¸°ì•„", en: "Kia" },
      "035420.KS": { ko: "NAVER", en: "NAVER" },
      "035720.KS": { ko: "ì¹´ì¹´ì˜¤", en: "Kakao" },
      "005490.KS": { ko: "POSCOí™€ë”©ìŠ¤", en: "POSCO Holdings" },
      "051910.KS": { ko: "LGí™”í•™", en: "LG Chem" },
      "006400.KS": { ko: "ì‚¼ì„±SDI", en: "Samsung SDI" },
      "207940.KS": { ko: "ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤", en: "Samsung Biologics" },
      "068270.KS": { ko: "ì…€íŠ¸ë¦¬ì˜¨", en: "Celltrion" },
      "AAPL": { ko: "ì• í”Œ", en: "Apple" },
      "MSFT": { ko: "ë§ˆì´í¬ë¡œì†Œí”„íŠ¸", en: "Microsoft" },
      "NVDA": { ko: "ì—”ë¹„ë””ì•„", en: "NVIDIA" },
      "AMZN": { ko: "ì•„ë§ˆì¡´", en: "Amazon" },
      "GOOGL": { ko: "ì•ŒíŒŒë²³", en: "Alphabet" },
      "META": { ko: "ë©”íƒ€", en: "Meta" },
      "TSLA": { ko: "í…ŒìŠ¬ë¼", en: "Tesla" },
      "BRK-B": { ko: "ë²„í¬ì…” í•´ì„œì›¨ì´", en: "Berkshire Hathaway" },
      "AVGO": { ko: "ë¸Œë¡œë“œì»´", en: "Broadcom" },
      "JPM": { ko: "JPëª¨ê±´", en: "JPMorgan Chase" },
      "V": { ko: "ë¹„ì", en: "Visa" },
      "MA": { ko: "ë§ˆìŠ¤í„°ì¹´ë“œ", en: "Mastercard" },
      "NFLX": { ko: "ë„·í”Œë¦­ìŠ¤", en: "Netflix" },
      "KO": { ko: "ì½”ì¹´ì½œë¼", en: "Coca-Cola" },
      "PEP": { ko: "í©ì‹œì½”", en: "PepsiCo" },
      "WMT": { ko: "ì›”ë§ˆíŠ¸", en: "Walmart" },
      "COST": { ko: "ì½”ìŠ¤íŠ¸ì½”", en: "Costco" },
      "JNJ": { ko: "ì¡´ìŠ¨ì•¤ë“œì¡´ìŠ¨", en: "Johnson & Johnson" },
      "PG": { ko: "í”„ë¡í„°ì•¤ê°¬ë¸”", en: "Procter & Gamble" },
      "UNH": { ko: "ìœ ë‚˜ì´í‹°ë“œí—¬ìŠ¤", en: "UnitedHealth" },
      "XOM": { ko: "ì—‘ìŠ¨ëª¨ë¹Œ", en: "Exxon Mobil" },
      "CVX": { ko: "ì…°ë¸Œë¡ ", en: "Chevron" }
    };

    async function loadCompanyMappings() {
      try {
        const res = await fetch(MAPPING_JSON_URL, { cache: "no-store" });
        if (!res.ok) return;
        const json = await res.json();
        const markets = json?.markets || {};
        const next = {};
        for (const marketKey of ["kr", "us"]) {
          const list = Array.isArray(markets[marketKey]) ? markets[marketKey] : [];
          list.forEach((row) => {
            const symbol = String(row?.symbol || "").toUpperCase();
            if (!symbol) return;
            next[symbol] = {
              ko: row?.ko || row?.en || symbol,
              en: row?.en || row?.ko || symbol
            };
          });
        }
        companyLabelsBySymbol = next;
      } catch (e) {
        console.warn("mapping load failed", e);
      }
    }

    function t(key) {
      return I18N[currentLang][key];
    }

    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.getElementById("lang-ko").classList.toggle("active-lang", lang === "ko");
      document.getElementById("lang-en").classList.toggle("active-lang", lang === "en");
      applyLanguage();
    }

    function applyLanguage() {
      document.getElementById("titleText").textContent = t("title");
      document.getElementById("tabUsText").textContent = t("tabUs");
      document.getElementById("tabKrText").textContent = t("tabKr");
      document.getElementById("usPanelTitle").textContent = t("usPanel");
      document.getElementById("krPanelTitle").textContent = t("krPanel");
      document.getElementById("usHint").textContent = t("usHint");
      document.getElementById("krHint").textContent = t("krHint");
      document.getElementById("runUsBtn").textContent = t("run");
      document.getElementById("runKrBtn").textContent = t("run");
      document.getElementById("usTicker").placeholder = t("usTicker");
      document.getElementById("usCompare1").placeholder = t("compare1");
      document.getElementById("usCompare2").placeholder = t("compare2");
      document.getElementById("krTicker").placeholder = t("krTicker");
      document.getElementById("krCompare1").placeholder = t("compare1");
      document.getElementById("krCompare2").placeholder = t("compare2");
      document.getElementById("usMoney").placeholder = t("startMoney");
      document.getElementById("krMoney").placeholder = t("startMoney");
      document.getElementById("usMonthly").placeholder = t("monthly");
      document.getElementById("krMonthly").placeholder = t("monthly");
    }

    function showPage(id) {
      document.querySelectorAll(".page").forEach((page) => page.classList.remove("active"));
      document.querySelectorAll(".tabs button").forEach((btn) => btn.classList.remove("active-tab"));
      document.getElementById(id).classList.add("active");
      document.getElementById(`tab-${id}`).classList.add("active-tab");
    }

    async function fetchData(symbol, startDate, market) {
      const from = Math.floor(new Date(startDate + "-01").getTime() / 1000);
      const to = Math.floor(Date.now() / 1000);
      const qs = `symbol=${encodeURIComponent(symbol)}&from=${from}&to=${to}&market=${encodeURIComponent(market)}`;
      let lastError = "API call failed";

      for (const endpoint of API_ENDPOINTS) {
        const url = endpoint.includes("?") ? `${endpoint}&${qs}` : `${endpoint}?${qs}`;

        try {
          const res = await fetch(url);
          const body = await res.text();

          if (!res.ok) {
            lastError = `HTTP ${res.status}: ${body.slice(0, 120)}`;
            continue;
          }

          const contentType = (res.headers.get("content-type") || "").toLowerCase();
          if (!contentType.includes("application/json")) {
            lastError = `Not JSON: ${body.slice(0, 120)}`;
            continue;
          }

          const trimmed = body.trim();
          if (!(trimmed.startsWith("{") || trimmed.startsWith("["))) {
            lastError = `Invalid JSON body: ${trimmed.slice(0, 120)}`;
            continue;
          }

          const json = JSON.parse(trimmed);
          const result = json?.chart?.result?.[0];
          if (!result) {
            lastError = "No chart result";
            continue;
          }

          return result;
        } catch (error) {
          lastError = String(error);
        }
      }

      throw new Error(lastError);
    }

    function getDisplayName(symbol, market, fallbackName) {
      const key = String(symbol || "").toUpperCase();
      const dynamic = companyLabelsBySymbol[key];
      if (dynamic) {
        return currentLang === "ko" ? dynamic.ko : dynamic.en;
      }
      const mapped = COMPANY_LABELS[key];
      if (mapped) {
        return currentLang === "ko" ? mapped.ko : mapped.en;
      }
      if (currentLang === "en" && fallbackName) return fallbackName;
      if (currentLang === "ko" && market === "kr" && fallbackName && /[ê°€-í£]/.test(fallbackName)) return fallbackName;
      return symbol;
    }

    function formatNumber(value) {
      return Number(value).toLocaleString(currentLang === "ko" ? "ko-KR" : "en-US", {
        maximumFractionDigits: 2
      });
    }

    function formatPercent(value) {
      return `${value >= 0 ? "+" : ""}${value.toFixed(2)}%`;
    }

    function animateChart(type, labels, datasetsInput) {
      if (chartTimers[type]) {
        clearInterval(chartTimers[type]);
      }
      if (charts[type]) {
        charts[type].destroy();
      }

      const ctx = document.getElementById(type + "Chart");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: datasetsInput.map((d) => ({
            label: d.label,
            data: [],
            borderWidth: 2,
            tension: 0.2
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          animation: false,
          plugins: {
            legend: { position: "bottom" }
          }
        }
      });

      charts[type] = chart;

      const total = labels.length;
      const ms = Math.max(40, Math.min(180, Math.floor(7000 / Math.max(total, 1))));
      let i = 0;

      chartTimers[type] = setInterval(() => {
        chart.data.labels.push(labels[i]);
        chart.data.datasets.forEach((ds, idx) => {
          ds.data.push(datasetsInput[idx].data[i]);
        });
        chart.update("none");

        i += 1;
        if (i >= total) {
          clearInterval(chartTimers[type]);
        }
      }, ms);
    }

    async function runBacktest(type) {
      const ticker = document.getElementById(type + "Ticker").value.trim();
      const compare1 = document.getElementById(type + "Compare1").value.trim();
      const compare2 = document.getElementById(type + "Compare2").value.trim();
      const start = document.getElementById(type + "Start").value;
      const money = parseFloat(document.getElementById(type + "Money").value);
      const monthly = parseFloat(document.getElementById(type + "Monthly").value || "0");
      const resultEl = document.getElementById(type + "Result");

      if (!ticker || !start || !money || money <= 0) {
        alert(t("alertInput"));
        return;
      }

      try {
        resultEl.textContent = t("loading");

        const compareInputs = [ticker, compare1, compare2]
          .map((v) => v.trim())
          .filter(Boolean);
        const uniqueInputs = [];
        const seen = new Set();
        compareInputs.forEach((v) => {
          const k = v.toLowerCase();
          if (!seen.has(k)) {
            seen.add(k);
            uniqueInputs.push(v);
          }
        });

        const stocks = await Promise.all(uniqueInputs.map((s) => fetchData(s, start, type)));
        const indexTicker = type === "us" ? "^GSPC" : "^KS11";
        const indexLabel = type === "us" ? t("indexUs") : t("indexKr");
        const index = await fetchData(indexTicker, start, type);

        const indexPrices = index?.indicators?.adjclose?.[0]?.adjclose || [];
        const indexTs = index?.timestamp || [];

        const indexMap = new Map();
        indexTs.forEach((ts, i) => {
          const p = indexPrices[i];
          if (p != null) indexMap.set(ts, p);
        });

        const stockSeries = stocks.map((s) => {
          const symbol = s?.meta?.symbol || "";
          const name = getDisplayName(symbol, type, s?.meta?.longName || s?.meta?.shortName);
          const prices = s?.indicators?.adjclose?.[0]?.adjclose || [];
          const ts = s?.timestamp || [];
          const priceMap = new Map();
          ts.forEach((t, i) => {
            const p = prices[i];
            if (p != null) priceMap.set(t, p);
          });
          return { symbol, name, priceMap, shares: 0, values: [] };
        });

        let indexShares = 0;
        const indexValue = [];
        const labels = [];

        indexTs.forEach((ts) => {
          const ip = indexMap.get(ts);
          if (ip == null) return;

          const prices = stockSeries.map((s) => s.priceMap.get(ts));
          if (prices.some((p) => p == null)) return;

          if (labels.length === 0) {
            stockSeries.forEach((s, idx) => {
              s.shares += money / prices[idx];
            });
            indexShares += money / ip;
          }

          if (monthly > 0) {
            stockSeries.forEach((s, idx) => {
              s.shares += monthly / prices[idx];
            });
            indexShares += monthly / ip;
          }

          labels.push(new Date(ts * 1000).toLocaleDateString(currentLang === "ko" ? "ko-KR" : "en-US"));
          stockSeries.forEach((s, idx) => {
            s.values.push(s.shares * prices[idx]);
          });
          indexValue.push(indexShares * ip);
        });

        if (!labels.length) {
          throw new Error(currentLang === "ko" ? "ê²¹ì¹˜ëŠ” ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." : "No overlapping data for selected period.");
        }

        const datasets = stockSeries.map((s) => ({ label: s.name, data: s.values }));
        datasets.push({ label: indexLabel, data: indexValue });
        animateChart(type, labels, datasets);

        const totalInvested = money + monthly * labels.length;
        const lastIndex = indexValue[indexValue.length - 1];
        const summaryRows = stockSeries.map((s) => {
          const last = s.values[s.values.length - 1];
          const ret = ((last - totalInvested) / totalInvested) * 100;
          return { label: s.name, last, ret };
        });
        summaryRows.push({
          label: indexLabel,
          last: lastIndex,
          ret: ((lastIndex - totalInvested) / totalInvested) * 100
        });

        let winner = summaryRows[0];
        summaryRows.forEach((r) => {
          if (r.last > winner.last) winner = r;
        });

        const valueText = summaryRows.map((r) => `${r.label} ${formatNumber(r.last)}`).join(" / ");
        const returnText = summaryRows.map((r) => `${r.label} ${formatPercent(r.ret)}`).join(" / ");
        resultEl.textContent = `${t("resultPrefix")}: ${valueText} | ${t("principalPrefix")}: ${formatNumber(totalInvested)} | ${t("returnPrefix")}: ${returnText} (${t("winner")}: ${winner.label})`;
      } catch (error) {
        console.error(error);
        resultEl.textContent = "";
        alert(`${t("errorPrefix")}: ${error.message}`);
      }
    }

    applyLanguage();
    loadCompanyMappings();
  </script>
</body>
</html>
