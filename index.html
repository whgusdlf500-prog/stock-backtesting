<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ê¸°íˆ¬ìì—°êµ¬ì†Œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-1: #111827;
      --bg-2: #1f2937;
      --bg-3: #0f172a;
      --card-bg: rgba(255, 255, 255, 0.9);
      --text: #111827;
      --muted: #475569;
      --btn: #0f172a;
      --btn-hover: #1e293b;
      --line: rgba(15, 23, 42, 0.13);
      --accent: #d97706;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 500px at -10% -10%, rgba(217, 119, 6, 0.22), transparent 60%),
        radial-gradient(1000px 480px at 110% 8%, rgba(148, 163, 184, 0.18), transparent 60%),
        linear-gradient(145deg, var(--bg-1), var(--bg-2) 45%, var(--bg-3));
      padding: 24px 16px 40px;
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 40vmax;
      height: 40vmax;
      border-radius: 999px;
      filter: blur(70px);
      pointer-events: none;
      z-index: 0;
      opacity: 0.3;
      animation: drift 18s ease-in-out infinite alternate;
    }

    body::before {
      background: rgba(217, 119, 6, 0.3);
      top: -16vmax;
      left: -14vmax;
    }

    body::after {
      background: rgba(148, 163, 184, 0.28);
      bottom: -18vmax;
      right: -14vmax;
      animation-delay: -5s;
    }

    @keyframes drift {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(20px, -18px) scale(1.08); }
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      background: var(--card-bg);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 22px;
      padding: 22px;
      box-shadow:
        0 20px 46px rgba(2, 6, 23, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.45);
      position: relative;
      z-index: 1;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    h1 {
      margin: 0;
      font-size: 30px;
      letter-spacing: -0.02em;
    }

    .lang-switch {
      display: flex;
      gap: 6px;
    }

    .lang-switch button {
      border: 1px solid #d1d5db;
      background: #ffffffd6;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lang-switch button:hover {
      transform: translateY(-1px);
    }

    .lang-switch button.active-lang {
      background: var(--btn);
      color: #fff;
      border-color: var(--btn);
    }

    .tabs {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .tabs button {
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      background: #eef2ff;
      color: #111827;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tabs button:hover {
      transform: translateY(-1px);
    }

    .tabs button.active-tab {
      background: var(--btn);
      color: white;
    }

    .live-strip {
      margin: 0 0 14px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.86));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .live-left {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #0f172a;
      font-weight: 700;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55);
      animation: pulse 1.4s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55); }
      70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    .live-right {
      font-size: 13px;
      color: #334155;
      font-weight: 600;
      min-height: 18px;
    }

    .mini-stats {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 0 0 14px;
    }

    .stat-pill {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 7px 11px;
      font-size: 12px;
      font-weight: 800;
      background: rgba(255,255,255,0.88);
      color: #0f172a;
    }

    .archive-cta {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(135deg, #ffffff, #eff6ff);
      padding: 12px;
      margin: 0 0 14px;
      text-align: center;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    .archive-cta a {
      display: inline-block;
      margin-top: 6px;
      text-decoration: none;
      font-weight: 800;
      color: #111827;
      border: 1px solid #111827;
      border-radius: 999px;
      padding: 8px 14px;
      background: #f9fafb;
    }

    .archive-cta a:hover {
      background: #111827;
      color: #fff;
    }

    .archive-cta:hover,
    .lookup-card:hover,
    .quality-card:hover,
    .idea-card:hover,
    .comments-card:hover,
    .contact-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.1);
    }

    .market-notice {
      margin: 0 0 14px;
      text-align: center;
      font-size: 13px;
      color: #64748b;
    }

    .page { display: none; }
    .page.active { display: block; }

    .panel-title {
      font-size: 20px;
      margin: 4px 0 12px;
      text-align: center;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .form-grid input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: #111827;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .run-row {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }

    .run-row button {
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #0f172a, #1f2937);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease, filter 0.2s ease;
    }

    .run-row button:hover {
      transform: translateY(-1px);
      filter: brightness(1.07);
    }

    .hint {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 10px;
    }

    .result {
      text-align: center;
      font-weight: 700;
      margin: 10px 0 8px;
      min-height: 24px;
      line-height: 1.45;
    }

    .result-line {
      margin: 4px 0;
    }

    .winner-highlight {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #111827;
      color: #fff;
      animation: popPulse 1.2s ease-in-out infinite;
    }

    .ret-up {
      color: #047857;
      font-weight: 800;
    }

    .ret-down {
      color: #b91c1c;
      font-weight: 800;
    }

    @keyframes popPulse {
      0% { transform: scale(1); opacity: 0.88; }
      50% { transform: scale(1.08); opacity: 1; }
      100% { transform: scale(1); opacity: 0.88; }
    }

    .chart-wrap {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.85);
    }

    .contact-card {
      margin-top: 22px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      padding: 14px;
    }

    .contact-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
      text-align: center;
    }

    .contact-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .contact-grid input,
    .contact-card textarea {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: #111827;
    }

    .contact-card textarea {
      min-height: 110px;
      resize: vertical;
      margin-bottom: 10px;
    }

    .contact-submit {
      display: flex;
      justify-content: center;
    }

    .contact-submit button {
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      background: var(--btn);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    .comments-card {
      margin-top: 22px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      padding: 14px;
    }

    .comments-card h3 {
      margin: 0 0 12px;
      font-size: 18px;
      text-align: center;
    }

    .idea-card {
      margin-top: 22px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      padding: 14px;
    }

    .idea-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
      text-align: center;
    }

    .idea-public-cta {
      text-align: center;
      margin-top: 8px;
    }

    .idea-public-cta a {
      display: inline-block;
      text-decoration: none;
      font-weight: 800;
      color: #111827;
      border: 1px solid #111827;
      border-radius: 999px;
      padding: 8px 14px;
      background: #f8fafc;
    }

    .idea-public-cta a:hover {
      background: #111827;
      color: #fff;
    }

    .lookup-card {
      margin: 12px 0 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      padding: 10px;
    }

    .lookup-title {
      font-size: 13px;
      font-weight: 800;
      color: #111827;
      margin: 0 0 8px;
    }

    .lookup-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      margin-bottom: 8px;
    }

    .lookup-row input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 9px 11px;
      font-size: 14px;
    }

    .lookup-row button {
      border: none;
      border-radius: 10px;
      padding: 9px 12px;
      font-weight: 700;
      background: #111827;
      color: #fff;
      cursor: pointer;
    }

    .lookup-result {
      font-size: 13px;
      color: #374151;
      line-height: 1.5;
      min-height: 19px;
    }

    .csv-card {
      margin: 0 0 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      padding: 10px;
    }

    .csv-title {
      font-size: 13px;
      font-weight: 800;
      color: #111827;
      margin: 0 0 8px;
    }

    .csv-row {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 8px;
      align-items: center;
    }

    .csv-row input[type="file"] {
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 7px;
      background: #fff;
      width: 100%;
    }

    .csv-row button {
      border: none;
      border-radius: 10px;
      padding: 9px 12px;
      font-weight: 700;
      background: #111827;
      color: #fff;
      cursor: pointer;
    }

    .csv-status {
      font-size: 13px;
      color: #334155;
      line-height: 1.5;
      min-height: 19px;
      margin-top: 8px;
    }

    .quality-card {
      margin-top: 22px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      padding: 14px;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    .lookup-card,
    .idea-card,
    .comments-card,
    .contact-card {
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    [data-reveal] {
      opacity: 0;
      transform: translateY(14px);
      transition: opacity 0.55s ease, transform 0.55s ease;
    }

    .in-view {
      opacity: 1 !important;
      transform: translateY(0) !important;
    }

    .quality-card h3 {
      margin: 0 0 10px;
      font-size: 19px;
    }

    .quality-card p,
    .quality-card li {
      color: #1f2937;
      font-size: 14px;
      line-height: 1.6;
    }

    .quality-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .quality-box {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fcfdff;
    }

    .investor-side {
      position: fixed;
      top: 96px;
      width: 200px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 10px;
      z-index: 0;
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.2);
    }

    .investor-left { left: 18px; }
    .investor-right { right: 18px; }
    .investor-left-2 { left: 18px; top: 470px; }
    .investor-right-2 { right: 18px; top: 470px; }

    .investor-side img {
      width: 100%;
      height: 230px;
      object-fit: cover;
      border-radius: 12px;
      display: block;
      margin-bottom: 8px;
    }

    .investor-side strong {
      display: block;
      color: #f8fafc;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .investor-side p {
      margin: 0;
      color: #cbd5e1;
      font-size: 12px;
      line-height: 1.45;
    }

    .form-grid input:focus,
    .lookup-row input:focus,
    .contact-grid input:focus,
    .contact-card textarea:focus {
      outline: none;
      border-color: rgba(14, 165, 233, 0.8);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.18);
    }

    .policy-links {
      margin-top: 16px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
    }

    .policy-links a {
      color: #1f2937;
      font-weight: 700;
      text-decoration: none;
      margin: 0 6px;
    }

    .policy-links a:hover {
      text-decoration: underline;
    }

    canvas {
      width: 100%;
      max-height: 420px;
    }

    @media (max-width: 700px) {
      .form-grid { grid-template-columns: 1fr; }
      .contact-grid { grid-template-columns: 1fr; }
      .quality-grid { grid-template-columns: 1fr; }
      .live-strip { padding: 10px; }
      .live-right { width: 100%; }
      h1 { font-size: 24px; }
      .top-row { justify-content: center; }
    }

    @media (max-width: 1500px) {
      .investor-side { display: none; }
    }
  </style>
</head>
<body>
  <aside class="investor-side investor-left" aria-hidden="true">
    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d4/Warren_Buffett_at_the_2015_SelectUSA_Investment_Summit_%28cropped%29.jpg" alt="Warren Buffett">
    <strong>Warren Buffett</strong>
    <p>â€œPrice is what you pay. Value is what you get.â€</p>
  </aside>
  <aside class="investor-side investor-left-2" aria-hidden="true">
    <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Benjamin_Graham_%281894-1976%29_portrait_on_23_March_1950.jpg" alt="Benjamin Graham">
    <strong>Benjamin Graham</strong>
    <p>â€œThe intelligent investor is a realist who sells to optimists and buys from pessimists.â€</p>
  </aside>
  <aside class="investor-side investor-right" aria-hidden="true">
    <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Charlie_Munger_%28cropped%29.jpg" alt="Charlie Munger">
    <strong>Charlie Munger</strong>
    <p>â€œThe big money is not in the buying and selling, but in the waiting.â€</p>
  </aside>
  <aside class="investor-side investor-right-2" aria-hidden="true">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/8b/Howard_Marks_2.17.12_%28cropped%29.jpg" alt="Howard Marks">
    <strong>Howard Marks</strong>
    <p>â€œBeing too far ahead of your time is indistinguishable from being wrong.â€</p>
  </aside>
  <div class="container">
    <div class="top-row">
      <h1 id="titleText">ì¥ê¸°íˆ¬ìì—°êµ¬ì†Œ</h1>
      <div class="lang-switch">
        <button id="lang-ko" class="active-lang" onclick="setLanguage('ko')">í•œêµ­ì–´</button>
        <button id="lang-en" onclick="setLanguage('en')">English</button>
      </div>
    </div>

    <div class="tabs">
      <button id="tab-us" class="active-tab" onclick="showPage('us')">ğŸ‡ºğŸ‡¸ <span id="tabUsText">ì„œí•™ê°œë¯¸</span></button>
      <button id="tab-kr" onclick="showPage('kr')">ğŸ‡°ğŸ‡· <span id="tabKrText">ë™í•™ê°œë¯¸</span></button>
    </div>

    <section class="live-strip" data-reveal>
      <div class="live-left">
        <span class="pulse-dot"></span>
        <span id="liveClock">ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤€ë¹„ì¤‘</span>
      </div>
      <div id="liveHint" class="live-right">ì¥ê¸° ë³µë¦¬ ê´€ì ì—ì„œ ì›” ì ë¦½ ì‹œë®¬ë ˆì´ì…˜ì„ ë¨¼ì € í™•ì¸í•´ ë³´ì„¸ìš”.</div>
    </section>

    <div class="mini-stats" data-reveal>
      <span class="stat-pill">KR: KOSPI + KOSDAQ</span>
      <span class="stat-pill">US: S&amp;P500 + NASDAQ ì£¼ìš” ì¢…ëª©</span>
      <span class="stat-pill">ì…ë ¥: ì¢…ëª©ëª…/í‹°ì»¤ ëª¨ë‘ ì§€ì›</span>
    </div>

    <p class="market-notice">ì¢…ëª© ê²€ìƒ‰ ë²”ìœ„ ì•ˆë‚´: í•œêµ­ì€ KOSPI + KOSDAQ ìƒì¥ì‚¬ ê²€ìƒ‰ì„ ì§€ì›í•©ë‹ˆë‹¤. ë¯¸êµ­ì€ S&amp;P500 + NASDAQ ì£¼ìš” ì¢…ëª© í¬í•¨ ê²€ìƒ‰ì„ ì§€ì›í•©ë‹ˆë‹¤.</p>

    <section id="us" class="page active" data-reveal>
      <h2 id="usPanelTitle" class="panel-title">S&amp;P500 ë¹„êµ (USD)</h2>
      <div class="lookup-card">
        <div id="usLookupTitle" class="lookup-title">ì¢…ëª©ì½”ë“œ ê²€ìƒ‰</div>
        <div class="lookup-row">
          <input id="usCodeSearch" placeholder="ì¢…ëª©ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì• í”Œ, NVIDIA)">
          <button id="usCodeSearchBtn" type="button" onclick="searchSymbols('us')">ì½”ë“œ ì°¾ê¸°</button>
        </div>
        <div id="usCodeSearchResult" class="lookup-result"></div>
      </div>
      <div class="csv-card">
        <div id="usCsvTitle" class="csv-title">CSV ë°ì´í„° ì—…ë¡œë“œ (ë¸Œë¼ìš°ì € ìºì‹œ ì €ì¥)</div>
        <div class="csv-row">
          <input id="usCsvFile" type="file" accept=".csv,text/csv">
          <button id="usCsvLoadBtn" type="button" onclick="loadCsvData('us')">ì—…ë¡œë“œ</button>
          <button id="usCsvTemplateBtn" type="button" onclick="downloadCsvTemplate('us')">í…œí”Œë¦¿</button>
          <button id="usCsvClearBtn" type="button" onclick="clearCsvData('us')">ì‚­ì œ</button>
        </div>
        <div id="usCsvStatus" class="csv-status"></div>
      </div>
      <div class="form-grid">
        <input id="usTicker" placeholder="í‹°ì»¤/íšŒì‚¬ëª… (ì˜ˆ: AAPL, ì• í”Œ)">
        <input id="usCompare1" placeholder="ë¹„êµ íšŒì‚¬ 1 (ì„ íƒ)">
        <input id="usCompare2" placeholder="ë¹„êµ íšŒì‚¬ 2 (ì„ íƒ)">
        <input type="month" id="usStart">
        <input type="number" id="usMoney" placeholder="ì´ˆê¸° íˆ¬ìê¸ˆ">
        <input type="number" id="usMonthly" placeholder="ì›” ì ë¦½ê¸ˆ (ì„ íƒ)">
      </div>
      <div class="run-row">
        <button id="runUsBtn" onclick="runBacktest('us')">ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      </div>
      <p id="usHint" class="hint">ì§€ìˆ˜ ë¹„êµ: S&amp;P500 / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì• í”Œ, ë§ˆì´í¬ë¡œì†Œí”„íŠ¸)</p>
      <p id="usResult" class="result"></p>
      <div class="chart-wrap">
        <canvas id="usChart"></canvas>
      </div>
    </section>

    <section id="kr" class="page" data-reveal>
      <h2 id="krPanelTitle" class="panel-title">KOSPI ë¹„êµ (KRW)</h2>
      <div class="lookup-card">
        <div id="krLookupTitle" class="lookup-title">ì¢…ëª©ì½”ë“œ ê²€ìƒ‰</div>
        <div class="lookup-row">
          <input id="krCodeSearch" placeholder="ì¢…ëª©ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì‚¼ì„±ì „ì, ì—ì½”í”„ë¡œë¹„ì— )">
          <button id="krCodeSearchBtn" type="button" onclick="searchSymbols('kr')">ì½”ë“œ ì°¾ê¸°</button>
        </div>
        <div id="krCodeSearchResult" class="lookup-result"></div>
      </div>
      <div class="csv-card">
        <div id="krCsvTitle" class="csv-title">CSV ë°ì´í„° ì—…ë¡œë“œ (ë¸Œë¼ìš°ì € ìºì‹œ ì €ì¥)</div>
        <div class="csv-row">
          <input id="krCsvFile" type="file" accept=".csv,text/csv">
          <button id="krCsvLoadBtn" type="button" onclick="loadCsvData('kr')">ì—…ë¡œë“œ</button>
          <button id="krCsvTemplateBtn" type="button" onclick="downloadCsvTemplate('kr')">í…œí”Œë¦¿</button>
          <button id="krCsvClearBtn" type="button" onclick="clearCsvData('kr')">ì‚­ì œ</button>
        </div>
        <div id="krCsvStatus" class="csv-status"></div>
      </div>
      <div class="form-grid">
        <input id="krTicker" placeholder="ì¢…ëª©ì½”ë“œ/íšŒì‚¬ëª… (ì˜ˆ: 005930.KS, ì‚¼ì„±ì „ì)">
        <input id="krCompare1" placeholder="ë¹„êµ íšŒì‚¬ 1 (ì„ íƒ)">
        <input id="krCompare2" placeholder="ë¹„êµ íšŒì‚¬ 2 (ì„ íƒ)">
        <input type="month" id="krStart">
        <input type="number" id="krMoney" placeholder="ì´ˆê¸° íˆ¬ìê¸ˆ">
        <input type="number" id="krMonthly" placeholder="ì›” ì ë¦½ê¸ˆ (ì„ íƒ)">
      </div>
      <div class="run-row">
        <button id="runKrBtn" onclick="runBacktest('kr')">ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      </div>
      <p id="krHint" class="hint">ì§€ìˆ˜ ë¹„êµ: KOSPI / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì‚¼ì„±ì „ì, LGì „ì)</p>
      <p id="krResult" class="result"></p>
      <div class="chart-wrap">
        <canvas id="krChart"></canvas>
      </div>
    </section>

    <section class="quality-card" data-reveal>
      <h3>íˆ¬ì í•™ìŠµ í—ˆë¸Œ</h3>
      <p>ì´ í˜ì´ì§€ëŠ” ë‹¨ìˆœ ì‹œì„¸ ì¡°íšŒê°€ ì•„ë‹ˆë¼ ì¥ê¸° íˆ¬ì íŒë‹¨ì„ ë•ëŠ” í•™ìŠµìš© ë„êµ¬ì…ë‹ˆë‹¤. ëª¨ë“  ìˆ˜ì¹˜ëŠ” ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì´ë©° ë¯¸ë˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <div class="quality-grid">
        <article class="quality-box">
          <h4>ë°±í…ŒìŠ¤íŠ¸ í•´ì„ ë°©ë²•</h4>
          <ul>
            <li>ì›ê¸ˆ, ìµœì¢… í‰ê°€ê¸ˆ, ìˆ˜ìµë¥ ì„ í•¨ê»˜ ë¹„êµí•˜ì„¸ìš”.</li>
            <li>ì›” ì ë¦½ê¸ˆì´ ìˆìœ¼ë©´ ì‹¤ì œ íˆ¬ì ìŠµê´€ê³¼ ìœ ì‚¬í•œ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>ë‹¨ê¸° êµ¬ê°„ë³´ë‹¤ 5ë…„ ì´ìƒ ì¥ê¸° êµ¬ê°„ì—ì„œ ë³€ë™ì„±ì„ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>
          </ul>
        </article>
        <article class="quality-box">
          <h4>ë°ì´í„° ì‚°ì¶œ ê¸°ì¤€</h4>
          <ul>
            <li>ë°ì´í„° ì¶œì²˜: ì‚¬ìš©ì ì—…ë¡œë“œ CSV (ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥)</li>
            <li>ì£¼ê¸°: CSVì— í¬í•¨ëœ ì›”/ì¼ ë°ì´í„° ê¸°ì¤€</li>
            <li>í•œêµ­ ì§€ìˆ˜ ë¹„êµ: KOSPI, ë¯¸êµ­ ì§€ìˆ˜ ë¹„êµ: S&amp;P500</li>
          </ul>
        </article>
        <article class="quality-box">
          <h4>íˆ¬ì ì‹œ ìœ ì˜ì‚¬í•­</h4>
          <ul>
            <li>ê³¼ê±° ìˆ˜ìµë¥ ì€ ë¯¸ë˜ ìˆ˜ìµë¥ ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
            <li>ì„¸ê¸ˆ, ìˆ˜ìˆ˜ë£Œ, í™˜ìœ¨, ìŠ¬ë¦¬í”¼ì§€ëŠ” ê¸°ë³¸ ê³„ì‚°ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</li>
            <li>ì‹¤ê±°ë˜ ì „ ì¦ê¶Œì‚¬ ì²´ê²° ê¸°ì¤€ê³¼ ê³µì‹œë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”.</li>
          </ul>
        </article>
        <article class="quality-box">
          <h4>ì‚¬ì´íŠ¸ ìš´ì˜ ì›ì¹™</h4>
          <ul>
            <li>ì‚¬ìš©ì ê²½í—˜ ìš°ì„ : ê³¼ë„í•œ íŒì—…/ê°•ì œ ì´ë™ ì—†ìŒ</li>
            <li>ì¤‘ë³µ/ë³µë¶™ í˜ì´ì§€ ëŒ€ì‹  í•µì‹¬ ì •ë³´ ì¤‘ì‹¬</li>
            <li>ë¬¸ì˜ ì±„ë„ê³¼ ëŒ“ê¸€ì„ í†µí•œ ì§€ì†ì ì¸ ê°œì„ </li>
          </ul>
        </article>
      </div>
    </section>

    <section class="idea-card" data-reveal>
      <h3>ì¥ê¸°íˆ¬ì ì˜ê²¬ ë‚¨ê¸°ê¸°</h3>
      <p class="hint">ì˜ê²¬ì€ ê³µê°œ ëŒ“ê¸€ ìŠ¤ë ˆë“œì— ë‚¨ê²¨ì£¼ì„¸ìš”. ë‹¤ë¥¸ ì‚¬ìš©ìë„ í•¨ê»˜ ì½ê³  í† ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p class="hint">í˜•ì‹ ì˜ˆì‹œ: íšŒì‚¬ëª… / ì‹œì¥(KR, US) / ì¥ê¸°íˆ¬ì ê´€ì (ê¸°ê°„, ê·¼ê±°)</p>
      <div class="idea-public-cta">
        <a href="#disqus_thread">ê³µê°œ ì˜ê²¬ ë‚¨ê¸°ëŸ¬ ê°€ê¸°</a>
      </div>
    </section>

    <section class="comments-card" data-reveal>
      <h3>ëŒ“ê¸€</h3>
      <p class="hint">ëˆ„ë½ë˜ê±°ë‚˜ ì˜¤ë¥˜ê°€ ìˆëŠ” íšŒì‚¬ëª…ì€ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ í™•ì¸ í›„ ë§¤í•‘ì— ë°˜ì˜í•˜ê² ìŠµë‹ˆë‹¤. ì—¬ëŸ¬ë¶„ì˜ ëŒ“ê¸€ì€ í° ì‘ì›ì´ ë©ë‹ˆë‹¤. ì¶”ê°€ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤ë©´ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì‹œë©´ ë°˜ì˜ë  ìˆ˜ ìˆë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
      <div id="disqus_thread"></div>
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </section>

    <section class="contact-card" data-reveal>
      <h3>ì œíœ´ ë¬¸ì˜</h3>
      <form action="https://formspree.io/f/xaqdjwzq" method="POST">
        <div class="contact-grid">
          <input type="text" name="name" placeholder="ì´ë¦„" required>
          <input type="email" name="email" placeholder="ì´ë©”ì¼" required>
        </div>
        <textarea name="message" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." required></textarea>
        <input type="hidden" name="_subject" value="ê°œë¯¸ ë°±í…ŒìŠ¤íŠ¸ ì œíœ´ ë¬¸ì˜">
        <div class="contact-submit">
          <button type="submit">ë¬¸ì˜ ë³´ë‚´ê¸°</button>
        </div>
      </form>
    </section>

    <div class="policy-links">
      <a href="/articles/">ë¶„ì„ ì•„ì¹´ì´ë¸Œ</a>
      <a href="/admin-mappings.html">ë§¤í•‘ ê´€ë¦¬ì</a>
      <a href="/about.html">ì‚¬ì´íŠ¸ ì†Œê°œ</a>
      <a href="/editorial-policy.html">í¸ì§‘ ì›ì¹™</a>
      <a href="/attributions.html">ì¶œì²˜ ë° ì €ì‘ê¶Œ</a>
      <a href="/privacy.html">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
      <a href="/terms.html">ì´ìš©ì•½ê´€</a>
      <span>ìµœì¢… ì—…ë°ì´íŠ¸: 2026-02-17</span>
    </div>
  </div>

  <script>
    const MAPPING_JSON_URL = "/company-mappings.json";
    const MISSING_MAPPING_STORAGE_KEY = "pendingMappingLogsV1";
    const CSV_CACHE_PREFIX = "localPriceSnapshotsV1:";
    const charts = {};
    const chartTimers = {};
    let currentLang = "ko";
    let companyLabelsBySymbol = {};
    let mappingRowsByMarket = { kr: [], us: [] };
    let marketDataStore = { kr: {}, us: {} };
    const missingLogSeen = new Set();

    const I18N = {
      ko: {
        title: "ì¥ê¸°íˆ¬ìì—°êµ¬ì†Œ",
        tabUs: "ì„œí•™ê°œë¯¸",
        tabKr: "ë™í•™ê°œë¯¸",
        usPanel: "S&P500 ë¹„êµ (USD)",
        krPanel: "KOSPI ë¹„êµ (KRW)",
        usHint: "ì§€ìˆ˜ ë¹„êµ: S&P500 / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì• í”Œ, ë§ˆì´í¬ë¡œì†Œí”„íŠ¸)",
        krHint: "ì§€ìˆ˜ ë¹„êµ: KOSPI / íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: ì‚¼ì„±ì „ì, LGì „ì)",
        run: "ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰",
        usTicker: "í‹°ì»¤/íšŒì‚¬ëª… (ì˜ˆ: AAPL, ì• í”Œ)",
        krTicker: "ì¢…ëª©ì½”ë“œ/íšŒì‚¬ëª… (ì˜ˆ: 005930.KS, ì‚¼ì„±ì „ì)",
        compare1: "ë¹„êµ íšŒì‚¬ 1 (ì„ íƒ)",
        compare2: "ë¹„êµ íšŒì‚¬ 2 (ì„ íƒ)",
        codeLookupPlaceholderUs: "ì¢…ëª©ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì• í”Œ, NVIDIA)",
        codeLookupPlaceholderKr: "ì¢…ëª©ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì‚¼ì„±ì „ì, ì—ì½”í”„ë¡œë¹„ì— )",
        codeLookupTitle: "ì¢…ëª©ì½”ë“œ ê²€ìƒ‰",
        codeLookupButton: "ì½”ë“œ ì°¾ê¸°",
        codeLookupEmpty: "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.",
        codeLookupNoResult: "ì¼ì¹˜í•˜ëŠ” ì¢…ëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.",
        codeLookupLoading: "ê²€ìƒ‰ ì¤‘...",
        csvTitle: "CSV ë°ì´í„° ì—…ë¡œë“œ (ë¸Œë¼ìš°ì € ìºì‹œ ì €ì¥)",
        csvLoad: "ì—…ë¡œë“œ",
        csvTemplate: "í…œí”Œë¦¿",
        csvClear: "ì‚­ì œ",
        csvNeedFile: "CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.",
        csvLoaded: "CSV ë¡œë”© ì™„ë£Œ",
        csvCleared: "ì €ì¥ëœ CSV ë°ì´í„°ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.",
        csvInvalid: "CSV í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í•„ìˆ˜ ì»¬ëŸ¼: date,symbol,adjclose(ë˜ëŠ” close).",
        csvMissing: "CSV ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.",
        csvHintUs: "ì˜ˆì‹œ: date,symbol,adjclose / ì§€ìˆ˜ ì‹¬ë³¼: ^GSPC ë˜ëŠ” S&P500 (í…œí”Œë¦¿ì€ ë¹ˆ í˜•ì‹ë§Œ ì œê³µ)",
        csvHintKr: "ì˜ˆì‹œ: date,symbol,adjclose / ì§€ìˆ˜ ì‹¬ë³¼: ^KS11 ë˜ëŠ” KOSPI (í…œí”Œë¦¿ì€ ë¹ˆ í˜•ì‹ë§Œ ì œê³µ)",
        startMoney: "ì´ˆê¸° íˆ¬ìê¸ˆ",
        monthly: "ì›” ì ë¦½ê¸ˆ (ì„ íƒ)",
        alertInput: "ì¢…ëª©, ì‹œì‘ì›”, ì´ˆê¸° íˆ¬ìê¸ˆì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.",
        loading: "ê³„ì‚° ì¤‘...",
        indexUs: "S&P500",
        indexKr: "KOSPI",
        winner: "ìš°ì„¸",
        resultPrefix: "ìµœì¢… í‰ê°€ê¸ˆ",
        principalPrefix: "ì›ê¸ˆ",
        returnPrefix: "ìˆ˜ìµë¥ ",
        errorPrefix: "ë°±í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"
      },
      en: {
        title: "Long-Term Investment Lab",
        tabUs: "US Stocks",
        tabKr: "Korean Stocks",
        usPanel: "S&P500 Comparison (USD)",
        krPanel: "KOSPI Comparison (KRW)",
        usHint: "Benchmark: S&P500 / Korean names allowed (e.g., ì• í”Œ, ë§ˆì´í¬ë¡œì†Œí”„íŠ¸)",
        krHint: "Benchmark: KOSPI / Korean names allowed (e.g., ì‚¼ì„±ì „ì, LGì „ì)",
        run: "Run Backtest",
        usTicker: "Ticker/Company (e.g., AAPL, ì• í”Œ)",
        krTicker: "Ticker/Company (e.g., 005930.KS, ì‚¼ì„±ì „ì)",
        compare1: "Compare company 1 (optional)",
        compare2: "Compare company 2 (optional)",
        codeLookupPlaceholderUs: "Find ticker (e.g., Apple, NVIDIA)",
        codeLookupPlaceholderKr: "Find ticker (e.g., ì‚¼ì„±ì „ì, ì—ì½”í”„ë¡œë¹„ì— )",
        codeLookupTitle: "Ticker Lookup",
        codeLookupButton: "Find Code",
        codeLookupEmpty: "Enter a keyword.",
        codeLookupNoResult: "No matching company found.",
        codeLookupLoading: "Searching...",
        csvTitle: "Upload CSV data (saved in browser cache)",
        csvLoad: "Upload",
        csvTemplate: "Template",
        csvClear: "Clear",
        csvNeedFile: "Please choose a CSV file.",
        csvLoaded: "CSV loaded",
        csvCleared: "Saved CSV data has been cleared.",
        csvInvalid: "Invalid CSV. Required columns: date,symbol,adjclose(or close).",
        csvMissing: "No CSV data found. Upload first.",
        csvHintUs: "Example: date,symbol,adjclose / index symbol: ^GSPC or S&P500 (template is header-only)",
        csvHintKr: "Example: date,symbol,adjclose / index symbol: ^KS11 or KOSPI (template is header-only)",
        startMoney: "Initial investment",
        monthly: "Monthly contribution (optional)",
        alertInput: "Please enter a valid symbol, start month, and initial investment.",
        loading: "Calculating...",
        indexUs: "S&P500",
        indexKr: "KOSPI",
        winner: "Winner",
        resultPrefix: "Final value",
        principalPrefix: "Principal",
        returnPrefix: "Return",
        errorPrefix: "Backtest failed"
      }
    };

    const COMPANY_LABELS = {
      "005930.KS": { ko: "ì‚¼ì„±ì „ì", en: "Samsung Electronics" },
      "066570.KS": { ko: "LGì „ì", en: "LG Electronics" },
      "000660.KS": { ko: "SKí•˜ì´ë‹‰ìŠ¤", en: "SK hynix" },
      "373220.KS": { ko: "LGì—ë„ˆì§€ì†”ë£¨ì…˜", en: "LG Energy Solution" },
      "005380.KS": { ko: "í˜„ëŒ€ì°¨", en: "Hyundai Motor" },
      "000270.KS": { ko: "ê¸°ì•„", en: "Kia" },
      "035420.KS": { ko: "NAVER", en: "NAVER" },
      "035720.KS": { ko: "ì¹´ì¹´ì˜¤", en: "Kakao" },
      "005490.KS": { ko: "POSCOí™€ë”©ìŠ¤", en: "POSCO Holdings" },
      "051910.KS": { ko: "LGí™”í•™", en: "LG Chem" },
      "006400.KS": { ko: "ì‚¼ì„±SDI", en: "Samsung SDI" },
      "207940.KS": { ko: "ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤", en: "Samsung Biologics" },
      "068270.KS": { ko: "ì…€íŠ¸ë¦¬ì˜¨", en: "Celltrion" },
      "AAPL": { ko: "ì• í”Œ", en: "Apple" },
      "MSFT": { ko: "ë§ˆì´í¬ë¡œì†Œí”„íŠ¸", en: "Microsoft" },
      "NVDA": { ko: "ì—”ë¹„ë””ì•„", en: "NVIDIA" },
      "AMZN": { ko: "ì•„ë§ˆì¡´", en: "Amazon" },
      "GOOGL": { ko: "ì•ŒíŒŒë²³", en: "Alphabet" },
      "META": { ko: "ë©”íƒ€", en: "Meta" },
      "TSLA": { ko: "í…ŒìŠ¬ë¼", en: "Tesla" },
      "BRK-B": { ko: "ë²„í¬ì…” í•´ì„œì›¨ì´", en: "Berkshire Hathaway" },
      "AVGO": { ko: "ë¸Œë¡œë“œì»´", en: "Broadcom" },
      "JPM": { ko: "JPëª¨ê±´", en: "JPMorgan Chase" },
      "V": { ko: "ë¹„ì", en: "Visa" },
      "MA": { ko: "ë§ˆìŠ¤í„°ì¹´ë“œ", en: "Mastercard" },
      "NFLX": { ko: "ë„·í”Œë¦­ìŠ¤", en: "Netflix" },
      "KO": { ko: "ì½”ì¹´ì½œë¼", en: "Coca-Cola" },
      "PEP": { ko: "í©ì‹œì½”", en: "PepsiCo" },
      "WMT": { ko: "ì›”ë§ˆíŠ¸", en: "Walmart" },
      "COST": { ko: "ì½”ìŠ¤íŠ¸ì½”", en: "Costco" },
      "JNJ": { ko: "ì¡´ìŠ¨ì•¤ë“œì¡´ìŠ¨", en: "Johnson & Johnson" },
      "PG": { ko: "í”„ë¡í„°ì•¤ê°¬ë¸”", en: "Procter & Gamble" },
      "UNH": { ko: "ìœ ë‚˜ì´í‹°ë“œí—¬ìŠ¤", en: "UnitedHealth" },
      "XOM": { ko: "ì—‘ìŠ¨ëª¨ë¹Œ", en: "Exxon Mobil" },
      "CVX": { ko: "ì…°ë¸Œë¡ ", en: "Chevron" }
    };

    async function loadCompanyMappings() {
      try {
        const res = await fetch(MAPPING_JSON_URL, { cache: "no-store" });
        if (!res.ok) return;
        const json = await res.json();
        const markets = json?.markets || {};
        const next = {};
        const rows = { kr: [], us: [] };
        for (const marketKey of ["kr", "us"]) {
          const list = Array.isArray(markets[marketKey]) ? markets[marketKey] : [];
          list.forEach((row) => {
            const symbol = String(row?.symbol || "").toUpperCase();
            if (!symbol) return;
            rows[marketKey].push({
              symbol,
              ko: String(row?.ko || ""),
              en: String(row?.en || ""),
              aliases: Array.isArray(row?.aliases) ? row.aliases.map((a) => String(a || "")) : []
            });
            next[symbol] = {
              ko: row?.ko || row?.en || symbol,
              en: row?.en || row?.ko || symbol
            };
          });
        }
        mappingRowsByMarket = rows;
        companyLabelsBySymbol = next;
      } catch (e) {
        console.warn("mapping load failed", e);
      }
    }

    function t(key) {
      return I18N[currentLang][key];
    }

    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.getElementById("lang-ko").classList.toggle("active-lang", lang === "ko");
      document.getElementById("lang-en").classList.toggle("active-lang", lang === "en");
      applyLanguage();
    }

    function applyLanguage() {
      document.getElementById("titleText").textContent = t("title");
      document.getElementById("tabUsText").textContent = t("tabUs");
      document.getElementById("tabKrText").textContent = t("tabKr");
      document.getElementById("usPanelTitle").textContent = t("usPanel");
      document.getElementById("krPanelTitle").textContent = t("krPanel");
      document.getElementById("usHint").textContent = t("usHint");
      document.getElementById("krHint").textContent = t("krHint");
      document.getElementById("runUsBtn").textContent = t("run");
      document.getElementById("runKrBtn").textContent = t("run");
      document.getElementById("usTicker").placeholder = t("usTicker");
      document.getElementById("usCompare1").placeholder = t("compare1");
      document.getElementById("usCompare2").placeholder = t("compare2");
      document.getElementById("krTicker").placeholder = t("krTicker");
      document.getElementById("krCompare1").placeholder = t("compare1");
      document.getElementById("krCompare2").placeholder = t("compare2");
      document.getElementById("usCodeSearch").placeholder = t("codeLookupPlaceholderUs");
      document.getElementById("krCodeSearch").placeholder = t("codeLookupPlaceholderKr");
      document.getElementById("usLookupTitle").textContent = t("codeLookupTitle");
      document.getElementById("krLookupTitle").textContent = t("codeLookupTitle");
      document.getElementById("usCodeSearchBtn").textContent = t("codeLookupButton");
      document.getElementById("krCodeSearchBtn").textContent = t("codeLookupButton");
      document.getElementById("usCsvTitle").textContent = `${t("csvTitle")} - ${t("csvHintUs")}`;
      document.getElementById("krCsvTitle").textContent = `${t("csvTitle")} - ${t("csvHintKr")}`;
      document.getElementById("usCsvLoadBtn").textContent = t("csvLoad");
      document.getElementById("krCsvLoadBtn").textContent = t("csvLoad");
      document.getElementById("usCsvTemplateBtn").textContent = t("csvTemplate");
      document.getElementById("krCsvTemplateBtn").textContent = t("csvTemplate");
      document.getElementById("usCsvClearBtn").textContent = t("csvClear");
      document.getElementById("krCsvClearBtn").textContent = t("csvClear");
      document.getElementById("usMoney").placeholder = t("startMoney");
      document.getElementById("krMoney").placeholder = t("startMoney");
      document.getElementById("usMonthly").placeholder = t("monthly");
      document.getElementById("krMonthly").placeholder = t("monthly");
      refreshCsvStatus("us");
      refreshCsvStatus("kr");
      refreshLiveHints(true);
    }

    function normalizeLookup(s) {
      return String(s || "")
        .toLowerCase()
        .replace(/\s+/g, "")
        .replace(/[^0-9a-z\u3131-\u318e\uac00-\ud7a3&.-]/g, "");
    }

    function getPendingLogs() {
      try {
        const raw = localStorage.getItem(MISSING_MAPPING_STORAGE_KEY);
        const parsed = JSON.parse(raw || "[]");
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function setPendingLogs(items) {
      try {
        localStorage.setItem(MISSING_MAPPING_STORAGE_KEY, JSON.stringify(items));
      } catch (_e) {
      }
    }

    function logMissingMapping(payload) {
      const query = String(payload?.query || "").trim();
      const market = String(payload?.market || "").toLowerCase();
      if (!query || !market) return;

      const key = `${market}:${normalizeLookup(query)}`;
      if (missingLogSeen.has(key)) return;
      missingLogSeen.add(key);

      const logs = getPendingLogs();
      if (logs.some((x) => `${x.market}:${normalizeLookup(x.query)}` === key)) return;

      const item = {
        query,
        market,
        suggestions: Array.isArray(payload?.suggestions) ? payload.suggestions.slice(0, 5) : [],
        source: "auto-backtest-error",
        created_at: new Date().toISOString()
      };
      logs.unshift(item);
      setPendingLogs(logs.slice(0, 300));

    }

    function buildLookupCandidates(raw) {
      const base = normalizeLookup(raw);
      if (!base) return [];
      const transforms = [
        (v) => v.replace(/^ì£¼ì‹íšŒì‚¬/, ""),
        (v) => v.replace(/ì£¼ì‹íšŒì‚¬/g, ""),
        (v) => v.replace(/^ì—˜ì§€/, "lg"),
        (v) => v.replace(/ì—˜ì§€/g, "lg"),
        (v) => v.replace(/^ì—ìŠ¤ì¼€ì´/, "sk"),
        (v) => v.replace(/ì—ìŠ¤ì¼€ì´/g, "sk"),
        (v) => v.replace(/ì¼€ì´í‹°ì•¤ì§€/g, "ktg"),
        (v) => v.replace(/ì•¤ë“œ/g, "and"),
        (v) => v.replace(/&/g, "and"),
        (v) => v.replace(/and/g, "&")
      ];

      const set = new Set([base]);
      const queue = [base];
      while (queue.length) {
        const cur = queue.shift();
        for (const fn of transforms) {
          const next = normalizeLookup(fn(cur));
          if (!next || set.has(next)) continue;
          set.add(next);
          queue.push(next);
        }
      }
      return Array.from(set);
    }

    async function searchSymbols(type) {
      const inputEl = document.getElementById(type + "CodeSearch");
      const resultEl = document.getElementById(type + "CodeSearchResult");
      const candidates = buildLookupCandidates(inputEl.value);
      if (!candidates.length) {
        resultEl.textContent = t("codeLookupEmpty");
        return;
      }

      resultEl.textContent = t("codeLookupLoading");
      const rows = Array.isArray(mappingRowsByMarket[type]) ? mappingRowsByMarket[type] : [];
      const localMatched = rows.filter((row) => {
        const checks = [row.symbol, row.ko, row.en].concat(row.aliases || []).map(normalizeLookup);
        return checks.some((v) => candidates.some((q) => v.includes(q)));
      }).slice(0, 5);

      const merged = new Map();
      localMatched.forEach((row) => {
        merged.set(row.symbol, { symbol: row.symbol, name: row.ko || row.en || row.symbol });
      });

      const finalItems = Array.from(merged.values()).slice(0, 8);
      if (!finalItems.length) {
        resultEl.textContent = t("codeLookupNoResult");
        return;
      }

      resultEl.innerHTML = finalItems
        .map((row) => `${row.name} (${row.symbol})`)
        .join("<br>");
    }

    function showPage(id) {
      document.querySelectorAll(".page").forEach((page) => page.classList.remove("active"));
      document.querySelectorAll(".tabs button").forEach((btn) => btn.classList.remove("active-tab"));
      document.getElementById(id).classList.add("active");
      document.getElementById(`tab-${id}`).classList.add("active-tab");
    }

    const liveHints = {
      ko: [
        "ì¥ê¸° ë³µë¦¬ ê´€ì ì—ì„œ ì›” ì ë¦½ ì‹œë®¬ë ˆì´ì…˜ì„ ë¨¼ì € í™•ì¸í•´ ë³´ì„¸ìš”.",
        "ì›ê¸ˆ/í‰ê°€ê¸ˆ/ìˆ˜ìµë¥ ì„ í•¨ê»˜ ë³´ëŠ” ìŠµê´€ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.",
        "ì¢…ëª©ëª… ì…ë ¥ì´ ì•ˆ ë˜ë©´ ì¢…ëª©ì½”ë“œ ê²€ìƒ‰ì°½ìœ¼ë¡œ ì½”ë“œë¶€í„° í™•ì¸í•´ ë³´ì„¸ìš”."
      ],
      en: [
        "Start with monthly contribution simulation for long-term compounding.",
        "Compare principal, final value, and returns together.",
        "If name matching fails, use ticker lookup first."
      ]
    };
    let hintIndex = 0;

    function refreshLiveHints(force) {
      const hintEl = document.getElementById("liveHint");
      if (!hintEl) return;
      if (force) hintIndex = 0;
      const list = liveHints[currentLang] || liveHints.ko;
      hintEl.textContent = list[hintIndex % list.length];
      hintIndex += 1;
    }

    function initLiveClock() {
      const el = document.getElementById("liveClock");
      if (!el) return;
      const tick = () => {
        const now = new Date();
        const locale = currentLang === "ko" ? "ko-KR" : "en-US";
        const text = now.toLocaleString(locale, {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
        el.textContent = `${currentLang === "ko" ? "ì—…ë°ì´íŠ¸" : "Updated"}: ${text}`;
      };
      tick();
      setInterval(tick, 30 * 1000);
      setInterval(() => refreshLiveHints(false), 5 * 1000);
    }

    function initRevealAnimations() {
      const targets = document.querySelectorAll("[data-reveal]");
      if (!targets.length) return;
      const io = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("in-view");
            io.unobserve(entry.target);
          }
        });
      }, { threshold: 0.12 });
      targets.forEach((el) => io.observe(el));
    }

    function csvCacheKey(market) {
      return `${CSV_CACHE_PREFIX}${market}`;
    }

    function loadCachedMarketData(market) {
      try {
        const raw = localStorage.getItem(csvCacheKey(market));
        const parsed = JSON.parse(raw || "{}");
        if (!parsed || typeof parsed !== "object" || !parsed.series) return {};
        return parsed.series;
      } catch {
        return {};
      }
    }

    function saveCachedMarketData(market, series) {
      const payload = {
        market,
        updatedAt: new Date().toISOString(),
        series
      };
      localStorage.setItem(csvCacheKey(market), JSON.stringify(payload));
    }

    function getCachedMeta(market) {
      try {
        const raw = localStorage.getItem(csvCacheKey(market));
        const parsed = JSON.parse(raw || "{}");
        return parsed && typeof parsed === "object" ? parsed : null;
      } catch {
        return null;
      }
    }

    function normalizeHeaderName(name) {
      return String(name || "").toLowerCase().replace(/[^a-z0-9]/g, "");
    }

    function parseCsvLine(line) {
      const out = [];
      let cur = "";
      let inQuote = false;
      for (let i = 0; i < line.length; i += 1) {
        const ch = line[i];
        if (ch === "\"") {
          if (inQuote && line[i + 1] === "\"") {
            cur += "\"";
            i += 1;
          } else {
            inQuote = !inQuote;
          }
        } else if (ch === "," && !inQuote) {
          out.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map((v) => v.trim());
    }

    function pickHeaderIndex(headerMap, keys) {
      for (const key of keys) {
        if (headerMap[key] != null) return headerMap[key];
      }
      return -1;
    }

    function parseTs(value) {
      const s = String(value || "").trim();
      if (!s) return 0;
      if (/^\d+$/.test(s)) {
        const n = Number(s);
        if (n > 10_000_000_000) return Math.floor(n / 1000);
        return n;
      }
      const ts = Date.parse(s);
      if (!Number.isFinite(ts)) return 0;
      return Math.floor(ts / 1000);
    }

    function normalizeUploadedSymbol(raw) {
      const s = String(raw || "").trim().toUpperCase();
      if (!s) return "";
      if (s === "S&P500" || s === "SP500" || s === "SNP500") return "^GSPC";
      if (s === "KOSPI") return "^KS11";
      return s;
    }

    function parsePriceCsv(text) {
      const lines = String(text || "").replace(/\r/g, "").split("\n").filter((line) => line.trim());
      if (lines.length < 2) {
        throw new Error(t("csvInvalid"));
      }

      const headerCols = parseCsvLine(lines[0]).map(normalizeHeaderName);
      const headerMap = {};
      headerCols.forEach((h, i) => {
        if (h) headerMap[h] = i;
      });

      const dateIdx = pickHeaderIndex(headerMap, ["date", "datetime", "timestamp", "time"]);
      const symbolIdx = pickHeaderIndex(headerMap, ["symbol", "ticker", "code", "ì¢…ëª©ì½”ë“œ", "ì¢…ëª©"]);
      const priceIdx = pickHeaderIndex(headerMap, ["adjclose", "adjustedclose", "close", "price", "ì¢…ê°€"]);

      if (dateIdx < 0 || symbolIdx < 0 || priceIdx < 0) {
        throw new Error(t("csvInvalid"));
      }

      const series = {};
      for (let i = 1; i < lines.length; i += 1) {
        const cols = parseCsvLine(lines[i]);
        if (!cols.length) continue;
        const symbol = normalizeUploadedSymbol(cols[symbolIdx]);
        const ts = parseTs(cols[dateIdx]);
        const price = Number(cols[priceIdx]);
        if (!symbol || !ts || !Number.isFinite(price) || price <= 0) continue;
        if (!series[symbol]) series[symbol] = [];
        series[symbol].push([ts, price]);
      }

      Object.keys(series).forEach((symbol) => {
        const dedup = new Map();
        series[symbol].forEach(([ts, price]) => dedup.set(ts, price));
        const sorted = Array.from(dedup.entries())
          .sort((a, b) => a[0] - b[0])
          .map(([ts, price]) => [ts, price]);
        series[symbol] = sorted;
      });

      if (!Object.keys(series).length) {
        throw new Error(t("csvInvalid"));
      }
      return series;
    }

    function refreshCsvStatus(type) {
      const el = document.getElementById(type + "CsvStatus");
      if (!el) return;
      const meta = getCachedMeta(type);
      const count = Object.keys(meta?.series || {}).length;
      if (!count) {
        el.textContent = t("csvMissing");
        return;
      }
      const dt = new Date(meta.updatedAt || Date.now());
      const locale = currentLang === "ko" ? "ko-KR" : "en-US";
      el.textContent = `${t("csvLoaded")}: ${count} symbols / ${dt.toLocaleString(locale)}`;
    }

    async function loadCsvData(type) {
      const input = document.getElementById(type + "CsvFile");
      const file = input?.files?.[0];
      const status = document.getElementById(type + "CsvStatus");
      if (!file) {
        if (status) status.textContent = t("csvNeedFile");
        return;
      }

      try {
        const text = await file.text();
        const series = parsePriceCsv(text);
        marketDataStore[type] = series;
        saveCachedMarketData(type, series);
        refreshCsvStatus(type);
      } catch (error) {
        if (status) status.textContent = `${t("errorPrefix")}: ${error.message}`;
      }
    }

    function downloadCsvTemplate(type) {
      const indexSymbol = type === "us" ? "^GSPC" : "^KS11";
      const content = [
        "date,symbol,adjclose",
        `YYYY-MM-DD,${indexSymbol},`,
        "YYYY-MM-DD,COMPANY_SYMBOL,"
      ].join("\n");
      const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `template-${type}-prices.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function clearCsvData(type) {
      localStorage.removeItem(csvCacheKey(type));
      marketDataStore[type] = {};
      const input = document.getElementById(type + "CsvFile");
      if (input) input.value = "";
      const status = document.getElementById(type + "CsvStatus");
      if (status) status.textContent = t("csvCleared");
    }

    function resolveSymbolFromInput(rawInput, market) {
      const raw = String(rawInput || "").trim();
      if (!raw) return "";
      const upper = raw.toUpperCase();
      if (upper === "S&P500" || upper === "SP500") return "^GSPC";
      if (upper === "KOSPI") return "^KS11";
      if (upper === "^GSPC" || upper === "^KS11") return upper;
      if (/^\d{6}\.(KS|KQ)$/i.test(raw)) return upper;
      if (/^[A-Z][A-Z0-9.-]{0,10}$/i.test(raw)) return upper;

      const candidates = buildLookupCandidates(raw);
      const rows = Array.isArray(mappingRowsByMarket[market]) ? mappingRowsByMarket[market] : [];
      for (const row of rows) {
        const checks = [row.symbol, row.ko, row.en].concat(row.aliases || []).map(normalizeLookup);
        const ok = checks.some((x) => candidates.some((q) => x === q));
        if (ok) return row.symbol;
      }

      for (const [symbol, names] of Object.entries(COMPANY_LABELS)) {
        const checks = [symbol, names.ko, names.en].map(normalizeLookup);
        const ok = checks.some((x) => candidates.some((q) => x === q));
        if (ok) return symbol;
      }

      return "";
    }

    function getSeriesFromLocal(symbolInput, startDate, market) {
      const symbol = resolveSymbolFromInput(symbolInput, market);
      if (!symbol) {
        logMissingMapping({ query: symbolInput, market });
        throw new Error(`${t("codeLookupNoResult")}: ${symbolInput}`);
      }

      const marketSeries = marketDataStore[market] || {};
      const rows = Array.isArray(marketSeries[symbol]) ? marketSeries[symbol] : [];
      if (!rows.length) {
        throw new Error(`${t("csvMissing")} (${symbol})`);
      }

      const fromTs = Math.floor(new Date(startDate + "-01").getTime() / 1000);
      const ts = [];
      const adjclose = [];
      rows.forEach(([tSec, price]) => {
        if (tSec >= fromTs) {
          ts.push(tSec);
          adjclose.push(price);
        }
      });

      if (!ts.length) {
        throw new Error(`${symbol}: ${currentLang === "ko" ? "ì‹œì‘ì¼ ì´í›„ ë°ì´í„° ì—†ìŒ" : "No data after start date"}`);
      }

      return {
        meta: { symbol },
        timestamp: ts,
        indicators: {
          adjclose: [{ adjclose }]
        }
      };
    }

    function getDisplayName(symbol, market, fallbackName) {
      const key = String(symbol || "").toUpperCase();
      const dynamic = companyLabelsBySymbol[key];
      if (dynamic) {
        return currentLang === "ko" ? dynamic.ko : dynamic.en;
      }
      const mapped = COMPANY_LABELS[key];
      if (mapped) {
        return currentLang === "ko" ? mapped.ko : mapped.en;
      }
      if (currentLang === "en" && fallbackName) return fallbackName;
      if (currentLang === "ko" && market === "kr" && fallbackName && /[ê°€-í£]/.test(fallbackName)) return fallbackName;
      return symbol;
    }

    function formatNumber(value) {
      return Number(value).toLocaleString(currentLang === "ko" ? "ko-KR" : "en-US", {
        maximumFractionDigits: 2
      });
    }

    function formatFinalValue(value, market) {
      const n = Number(value).toLocaleString(currentLang === "ko" ? "ko-KR" : "en-US", {
        maximumFractionDigits: 0
      });
      if (market === "us") return `${n} USD`;
      return `${n}ì›`;
    }

    function formatPercent(value) {
      return `${value >= 0 ? "+" : ""}${value.toFixed(2)}%`;
    }

    function easeOutCubic(t) {
      return 1 - Math.pow(1 - t, 3);
    }

    function animateNumber(from, to, durationMs, onUpdate, onDone) {
      const start = performance.now();
      function frame(now) {
        const p = Math.min(1, (now - start) / durationMs);
        const eased = easeOutCubic(p);
        onUpdate(from + (to - from) * eased);
        if (p < 1) {
          requestAnimationFrame(frame);
        } else if (onDone) {
          onDone();
        }
      }
      requestAnimationFrame(frame);
    }

    function renderResultAnimated(resultEl, type, totalInvested, summaryRows, winnerLabel) {
      const principalText = `${t("principalPrefix")}: ${formatFinalValue(totalInvested, type)}`;
      const valueText = summaryRows.map((r) => `${r.label} ${formatFinalValue(r.last, type)}`).join(" / ");
      const lines = [
        `<div class="result-line">${principalText}</div>`,
        `<div class="result-line">${t("resultPrefix")}: ${valueText}</div>`,
        `<div id="retLine" class="result-line">${t("returnPrefix")}: ...</div>`
      ];
      resultEl.innerHTML = lines.join("");

      const retLine = resultEl.querySelector("#retLine");
      const from = summaryRows.map(() => 0);
      const to = summaryRows.map((r) => r.ret);

      animateNumber(0, 1, 1300, (progress) => {
        const nowVals = to.map((v, i) => from[i] + (v - from[i]) * progress);
        const retText = nowVals.map((v, idx) => {
          const cls = v >= 0 ? "ret-up" : "ret-down";
          return `${summaryRows[idx].label} <span class="${cls}">${formatPercent(v)}</span>`;
        }).join(" / ");
        retLine.innerHTML = `${t("returnPrefix")}: ${retText} (${t("winner")}: <span class="winner-highlight">${winnerLabel}</span>)`;
      });
    }

    function animateChart(type, labels, datasetsInput) {
      if (chartTimers[type]) {
        clearInterval(chartTimers[type]);
      }
      if (charts[type]) {
        charts[type].destroy();
      }

      const ctx = document.getElementById(type + "Chart");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: datasetsInput.map((d) => ({
            label: d.label,
            data: [],
            borderWidth: 2,
            tension: 0.2
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          animation: false,
          plugins: {
            legend: { position: "bottom" }
          }
        }
      });

      charts[type] = chart;

      const total = labels.length;
      const ms = Math.max(40, Math.min(180, Math.floor(7000 / Math.max(total, 1))));
      let i = 0;

      chartTimers[type] = setInterval(() => {
        chart.data.labels.push(labels[i]);
        chart.data.datasets.forEach((ds, idx) => {
          ds.data.push(datasetsInput[idx].data[i]);
        });
        chart.update("none");

        i += 1;
        if (i >= total) {
          clearInterval(chartTimers[type]);
        }
      }, ms);
    }

    async function runBacktest(type) {
      const ticker = document.getElementById(type + "Ticker").value.trim();
      const compare1 = document.getElementById(type + "Compare1").value.trim();
      const compare2 = document.getElementById(type + "Compare2").value.trim();
      const start = document.getElementById(type + "Start").value;
      const money = parseFloat(document.getElementById(type + "Money").value);
      const monthly = parseFloat(document.getElementById(type + "Monthly").value || "0");
      const resultEl = document.getElementById(type + "Result");

      if (!ticker || !start || !money || money <= 0) {
        alert(t("alertInput"));
        return;
      }

      try {
        resultEl.textContent = t("loading");

        const compareInputs = [ticker, compare1, compare2]
          .map((v) => v.trim())
          .filter(Boolean);
        const uniqueInputs = [];
        const seen = new Set();
        compareInputs.forEach((v) => {
          const k = v.toLowerCase();
          if (!seen.has(k)) {
            seen.add(k);
            uniqueInputs.push(v);
          }
        });

        if (!Object.keys(marketDataStore[type] || {}).length) {
          throw new Error(t("csvMissing"));
        }

        const stocks = uniqueInputs.map((s) => getSeriesFromLocal(s, start, type));
        const indexTicker = type === "us" ? "^GSPC" : "^KS11";
        const indexLabel = type === "us" ? t("indexUs") : t("indexKr");
        const index = getSeriesFromLocal(indexTicker, start, type);

        const indexPrices = index?.indicators?.adjclose?.[0]?.adjclose || [];
        const indexTs = index?.timestamp || [];

        const indexMap = new Map();
        indexTs.forEach((ts, i) => {
          const p = indexPrices[i];
          if (p != null) indexMap.set(ts, p);
        });

        const stockSeries = stocks.map((s) => {
          const symbol = s?.meta?.symbol || "";
          const name = getDisplayName(symbol, type, s?.meta?.longName || s?.meta?.shortName);
          const prices = s?.indicators?.adjclose?.[0]?.adjclose || [];
          const ts = s?.timestamp || [];
          const priceMap = new Map();
          ts.forEach((t, i) => {
            const p = prices[i];
            if (p != null) priceMap.set(t, p);
          });
          return { symbol, name, priceMap, shares: 0, values: [] };
        });

        let indexShares = 0;
        const indexValue = [];
        const labels = [];

        indexTs.forEach((ts) => {
          const ip = indexMap.get(ts);
          if (ip == null) return;

          const prices = stockSeries.map((s) => s.priceMap.get(ts));
          if (prices.some((p) => p == null)) return;

          if (labels.length === 0) {
            stockSeries.forEach((s, idx) => {
              s.shares += money / prices[idx];
            });
            indexShares += money / ip;
          }

          if (monthly > 0) {
            stockSeries.forEach((s, idx) => {
              s.shares += monthly / prices[idx];
            });
            indexShares += monthly / ip;
          }

          labels.push(new Date(ts * 1000).toLocaleDateString(currentLang === "ko" ? "ko-KR" : "en-US"));
          stockSeries.forEach((s, idx) => {
            s.values.push(s.shares * prices[idx]);
          });
          indexValue.push(indexShares * ip);
        });

        if (!labels.length) {
          throw new Error(currentLang === "ko" ? "ê²¹ì¹˜ëŠ” ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." : "No overlapping data for selected period.");
        }

        const datasets = stockSeries.map((s) => ({ label: s.name, data: s.values }));
        datasets.push({ label: indexLabel, data: indexValue });
        animateChart(type, labels, datasets);

        const totalInvested = money + monthly * labels.length;
        const lastIndex = indexValue[indexValue.length - 1];
        const summaryRows = stockSeries.map((s) => {
          const last = s.values[s.values.length - 1];
          const ret = ((last - totalInvested) / totalInvested) * 100;
          return { label: s.name, last, ret };
        });
        summaryRows.push({
          label: indexLabel,
          last: lastIndex,
          ret: ((lastIndex - totalInvested) / totalInvested) * 100
        });

        let winner = summaryRows[0];
        summaryRows.forEach((r) => {
          if (r.last > winner.last) winner = r;
        });

        renderResultAnimated(resultEl, type, totalInvested, summaryRows, winner.label);
      } catch (error) {
        console.error(error);
        resultEl.textContent = "";
        alert(`${t("errorPrefix")}: ${error.message}`);
      }
    }

    function initCsvStore() {
      marketDataStore.us = loadCachedMarketData("us");
      marketDataStore.kr = loadCachedMarketData("kr");
      refreshCsvStatus("us");
      refreshCsvStatus("kr");
    }

    initCsvStore();
    applyLanguage();
    loadCompanyMappings();
    initLiveClock();
    initRevealAnimations();
  </script>
  <script>
    (function() {
      var d = document;
      var s = d.createElement("script");
      s.src = "https://stockking.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
</body>
</html>
