<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="나는솔로 스타일 세계관 캐릭터 테스트. 10문항 퀴즈로 결과를 확인하고 공유 카드를 만들 수 있습니다. 사진은 브라우저에서만 처리됩니다." />
  <meta name="robots" content="index,follow" />
  <title>나는솔로 스타일 캐릭터 테스트</title>

  <!-- 실제 배포 시 ca-pub-xxxxxxxxxxxxxxxx 값으로 변경 -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0000000000000000" crossorigin="anonymous"></script>

  <style>
    :root {
      --bg: #06101d;
      --bg2: #0b1a2d;
      --card: rgba(255, 255, 255, 0.07);
      --line: rgba(255, 255, 255, 0.16);
      --text: #eaf3ff;
      --sub: #b6c7e4;
      --mint: #6be3c7;
      --blue: #79a9ff;
      --amber: #ffd38b;
      --danger: #ff7f96;
      --radius: 18px;
      --shadow: 0 16px 48px rgba(0, 0, 0, 0.38);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(121, 169, 255, 0.2), transparent 60%),
        radial-gradient(800px 480px at 90% 15%, rgba(107, 227, 199, 0.16), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    a { color: inherit; }

    .wrap {
      max-width: 1080px;
      margin: 0 auto;
      padding: 16px;
    }

    .top {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: conic-gradient(from 230deg, #79a9ff, #6be3c7, #ffd38b, #79a9ff);
      box-shadow: 0 8px 20px rgba(121, 169, 255, 0.35);
    }

    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: -0.02em;
    }

    .sub {
      margin-top: 4px;
      color: var(--sub);
      font-size: 13px;
      line-height: 1.5;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      transition: transform .15s ease, background .15s ease;
    }

    .btn:hover { transform: translateY(-1px); background: rgba(255, 255, 255, 0.14); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .btn.primary { background: linear-gradient(90deg, rgba(121,169,255,.26), rgba(107,227,199,.18)); }
    .btn.warn { border-color: rgba(255, 127, 150, 0.5); }

    .grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1.08fr 0.92fr;
      gap: 14px;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .hd {
      padding: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title { font-size: 14px; font-weight: 800; }
    .hint { color: var(--sub); font-size: 12px; margin-top: 4px; line-height: 1.45; }
    .bd { padding: 14px; }

    .resultBox {
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      padding: 12px;
    }

    .resultTitle {
      font-size: 22px;
      line-height: 1.3;
      margin: 0;
      letter-spacing: -0.02em;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .col {
      flex: 1;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      color: var(--sub);
      font-size: 12px;
    }

    .in, select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(4, 12, 24, 0.75);
      color: var(--text);
      padding: 10px;
    }

    .hide { display: none !important; }

    .qText {
      font-size: 20px;
      font-weight: 800;
      margin: 4px 0 12px;
      letter-spacing: -0.02em;
    }

    .answers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 560px) {
      .answers { grid-template-columns: 1fr; }
    }

    .ans {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding: 12px;
      cursor: pointer;
      text-align: left;
      font-weight: 700;
    }

    .ans:hover { background: rgba(255,255,255,0.1); }
    .ans small { display: block; color: var(--sub); font-weight: 500; margin-top: 6px; }

    .progress {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.13);
      background: rgba(255,255,255,0.08);
      overflow: hidden;
    }

    .progress > div {
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--blue), var(--mint), var(--amber));
      transition: width .16s ease;
    }

    .kpi {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    @media (max-width: 560px) {
      .kpi { grid-template-columns: repeat(2, 1fr); }
    }

    .tile {
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      padding: 10px;
    }

    .tile .t { color: var(--sub); font-size: 12px; }
    .tile .v { font-weight: 800; font-size: 18px; margin-top: 4px; }

    .badge {
      display: inline-block;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid var(--line);
      margin-right: 6px;
      font-size: 12px;
      font-weight: 800;
    }

    .adbox {
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      padding: 10px;
      color: var(--sub);
      font-size: 12px;
    }

    .adlabel {
      display: inline-block;
      margin-bottom: 6px;
      font-size: 11px;
      letter-spacing: 0.02em;
      color: var(--sub);
    }

    .footnote {
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      color: var(--sub);
      font-size: 12px;
      line-height: 1.65;
      padding: 12px;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      display: none;
      z-index: 20;
    }

    .toast.show { display: block; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.56);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 30;
    }

    .modal.show { display: flex; }

    .box {
      width: min(860px, 96vw);
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(10,20,34,0.98);
      overflow: hidden;
    }

    .mh {
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
    }

    .mb {
      padding: 12px;
      color: var(--sub);
      font-size: 13px;
      line-height: 1.65;
    }

    canvas.share {
      width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: #081425;
    }

    .links {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
      color: var(--sub);
    }

    .faq {
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.12);
      padding-top: 10px;
    }

    .faq h3 { margin: 0 0 8px; font-size: 14px; }
    .faq p { margin: 0 0 8px; color: var(--sub); font-size: 13px; line-height: 1.6; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>나는솔로 스타일 캐릭터 테스트</h1>
          <div class="sub">
            예능 세계관을 모티브로 만든 오락용 성향 테스트입니다. 실제 방송/출연자와 무관하며 결과는 재미를 위한 안내입니다.
          </div>
        </div>
      </div>
      <div class="toolbar">
        <button type="button" class="btn" id="btnHow">사용 안내</button>
        <button type="button" class="btn" id="btnOpenShare" disabled>공유 카드</button>
        <button type="button" class="btn warn" id="btnReset">기록 초기화</button>
      </div>
    </header>

    <div class="adbox" aria-label="상단 광고">
      <span class="adlabel">광고</span>
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-0000000000000000"
           data-ad-slot="1111111111"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
    </div>

    <main class="grid">
      <section class="card" aria-label="테스트 영역">
        <div class="hd">
          <div>
            <div class="title">테스트 진행</div>
            <div class="hint">10문항을 선택하면 성향 점수와 캐릭터 설명을 보여줍니다.</div>
          </div>
          <div class="toolbar">
            <button type="button" class="btn primary" id="btnStart">시작하기</button>
            <button type="button" class="btn" id="btnRandom">랜덤 강화</button>
            <button type="button" class="btn" id="btnRestart" disabled>다시하기</button>
          </div>
        </div>

        <div class="bd">
          <div id="viewLanding">
            <div class="resultBox">
              <h2 class="resultTitle">오늘의 캐릭터를 확인해보세요</h2>
              <p class="sub" style="margin-top:8px;">
                질문 답변 + 랜덤 가중치를 조합해 결과를 생성합니다. 같은 사람이 다시 해도 약간 다른 버전이 나올 수 있습니다.
              </p>

              <div class="row" style="margin-top:10px;">
                <div class="col">
                  <label for="nickname">닉네임(선택)</label>
                  <input class="in" id="nickname" maxlength="18" placeholder="예: 오늘의 나" />
                </div>
                <div class="col">
                  <label for="photoInput">사진(선택, 공유 카드 장식용)</label>
                  <input class="in" id="photoInput" type="file" accept="image/png,image/jpeg,image/webp" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button type="button" class="btn primary" id="btnStart2">퀴즈 시작</button>
                <button type="button" class="btn" id="btnSkip">빠른 결과</button>
              </div>
            </div>

            <div class="footnote">
              사진 파일은 브라우저 메모리에서만 사용되며 서버로 업로드하지 않습니다. 파일 크기는 5MB 이하만 허용됩니다.
            </div>
          </div>

          <div id="viewQuiz" class="hide">
            <div class="row" style="justify-content:space-between;">
              <strong><span id="qIndex">1</span> / <span id="qTotal">10</span></strong>
              <span class="sub">진행률</span>
            </div>
            <div class="progress" aria-label="퀴즈 진행률"><div id="qProg"></div></div>

            <div class="qText" id="qText">질문</div>
            <div class="answers" id="answers"></div>

            <div class="adbox" id="adMid" aria-label="중간 광고" style="display:none;">
              <span class="adlabel">광고</span>
              <ins class="adsbygoogle"
                   style="display:block"
                   data-ad-client="ca-pub-0000000000000000"
                   data-ad-slot="2222222222"
                   data-ad-format="auto"
                   data-full-width-responsive="true"></ins>
            </div>
          </div>

          <div id="viewResult" class="hide">
            <div class="resultBox">
              <div id="resultBadges" style="margin-bottom:8px;"></div>
              <h2 class="resultTitle" id="resultTitle">결과</h2>
              <p class="sub" id="resultSubtitle">설명</p>

              <div class="kpi">
                <div class="tile"><div class="t">혼돈지수</div><div class="v" id="kChaos">-</div></div>
                <div class="tile"><div class="t">호감도</div><div class="v" id="kLike">-</div></div>
                <div class="tile"><div class="t">대화력</div><div class="v" id="kTalk">-</div></div>
                <div class="tile"><div class="t">분위기</div><div class="v" id="kVibe">-</div></div>
              </div>

              <div class="footnote" id="resultTips"></div>

              <div class="adbox" aria-label="결과 광고">
                <span class="adlabel">광고</span>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-0000000000000000"
                     data-ad-slot="3333333333"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
              </div>

              <div class="row" style="margin-top:10px;">
                <button type="button" class="btn primary" id="btnTryAgain">다시하기</button>
                <button type="button" class="btn" id="btnMakeShare">공유 카드 만들기</button>
                <button type="button" class="btn" id="btnCopyText">결과 문구 복사</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="card" aria-label="설정 및 안내">
        <div class="hd">
          <div>
            <div class="title">설정</div>
            <div class="hint">강도와 랜덤 비율을 조정해 결과 다양성을 바꿀 수 있습니다.</div>
          </div>
        </div>
        <div class="bd">
          <div class="col">
            <label for="memeLevel">표현 강도</label>
            <select id="memeLevel" class="in">
              <option value="SAFE">안전</option>
              <option value="SPICY" selected>기본</option>
              <option value="CHAOS">강함</option>
            </select>
          </div>

          <div class="col" style="margin-top:10px;">
            <label for="randMix">랜덤 비율</label>
            <select id="randMix" class="in">
              <option value="20">20%</option>
              <option value="30" selected>30%</option>
              <option value="40">40%</option>
            </select>
          </div>

          <div class="footnote" style="margin-top:12px;">
            <strong>운영 기준</strong><br />
            1) 사람을 비하하거나 민감 속성을 판단하는 문항은 제외합니다.<br />
            2) 결과는 오락용 문구로만 제공하며 의학·법률·재정 조언을 하지 않습니다.<br />
            3) 광고와 콘텐츠 영역을 명확히 구분합니다.
          </div>

          <div class="faq">
            <h3>자주 묻는 질문</h3>
            <p><strong>Q.</strong> 결과가 매번 같은가요?<br /><strong>A.</strong> 문항 점수에 랜덤 가중치가 더해져 비슷하지만 약간 다른 결과가 나올 수 있습니다.</p>
            <p><strong>Q.</strong> 사진은 어디에 저장되나요?<br /><strong>A.</strong> 공유 카드 렌더링에만 사용되며 서버 업로드를 하지 않습니다.</p>
          </div>

          <nav class="links" aria-label="정책 링크">
            <a href="/about.html">사이트 소개</a>
            <a href="/editorial-policy.html">편집 원칙</a>
            <a href="/privacy.html">개인정보처리방침</a>
            <a href="/terms.html">이용약관</a>
          </nav>
        </div>
      </aside>
    </main>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="modal" id="mHow" aria-hidden="true">
    <div class="box">
      <div class="mh">
        <div>
          <strong>사용 안내</strong>
          <div class="sub">1) 시작하기 2) 문항 선택 3) 결과 확인 4) 공유 카드 저장</div>
        </div>
        <button type="button" class="btn" data-close="#mHow">닫기</button>
      </div>
      <div class="mb">
        본 페이지는 오락용 테스트입니다. 실제 인물/방송과 관련이 없으며, 결과는 재미를 위한 설명입니다.
      </div>
    </div>
  </div>

  <div class="modal" id="mShare" aria-hidden="true">
    <div class="box">
      <div class="mh">
        <div>
          <strong>공유 카드</strong>
          <div class="sub">PNG 파일로 저장할 수 있습니다.</div>
        </div>
        <button type="button" class="btn" data-close="#mShare">닫기</button>
      </div>
      <div class="mb">
        <canvas class="share" id="shareCanvas" width="1200" height="630"></canvas>
        <div class="row" style="margin-top:10px;">
          <button type="button" class="btn" id="btnDownloadShare">이미지 저장</button>
          <button type="button" class="btn" id="btnCopyShareText">공유 문구 복사</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const LS_BEST = "nsol_best_today_v2";
    const LS_LAST = "nsol_last_result_v2";
    const TODAY = new Date().toISOString().slice(0, 10);

    const els = {
      viewLanding: $("#viewLanding"),
      viewQuiz: $("#viewQuiz"),
      viewResult: $("#viewResult"),
      btnHow: $("#btnHow"),
      btnOpenShare: $("#btnOpenShare"),
      btnReset: $("#btnReset"),
      btnStart: $("#btnStart"),
      btnStart2: $("#btnStart2"),
      btnSkip: $("#btnSkip"),
      btnRandom: $("#btnRandom"),
      btnRestart: $("#btnRestart"),
      btnTryAgain: $("#btnTryAgain"),
      btnMakeShare: $("#btnMakeShare"),
      btnCopyText: $("#btnCopyText"),
      nickname: $("#nickname"),
      photoInput: $("#photoInput"),
      memeLevel: $("#memeLevel"),
      randMix: $("#randMix"),
      qIndex: $("#qIndex"),
      qTotal: $("#qTotal"),
      qProg: $("#qProg"),
      qText: $("#qText"),
      answers: $("#answers"),
      resultBadges: $("#resultBadges"),
      resultTitle: $("#resultTitle"),
      resultSubtitle: $("#resultSubtitle"),
      resultTips: $("#resultTips"),
      kChaos: $("#kChaos"),
      kLike: $("#kLike"),
      kTalk: $("#kTalk"),
      kVibe: $("#kVibe"),
      toast: $("#toast"),
      mHow: $("#mHow"),
      mShare: $("#mShare"),
      shareCanvas: $("#shareCanvas"),
      btnDownloadShare: $("#btnDownloadShare"),
      btnCopyShareText: $("#btnCopyShareText"),
    };

    const QUESTIONS = [
      { q: "처음 만남에서 나의 기본 모드는?", a: [
        { t: "차분하게 분위기를 본다", s: { vibe: 2, like: 1 } },
        { t: "대화를 주도하며 아이스브레이킹", s: { talk: 2, chaos: 1 } },
        { t: "상대 말에 리액션을 크게 준다", s: { like: 2, talk: 1 } },
        { t: "적응 후 천천히 내 스타일을 꺼낸다", s: { vibe: 1, chaos: 1 } },
      ]},
      { q: "호감이 생기면 보통 어떻게 행동하나요?", a: [
        { t: "솔직하게 표현한다", s: { talk: 1, chaos: 2 } },
        { t: "상대 속도에 맞춘다", s: { like: 2, vibe: 1 } },
        { t: "대화로 공감대를 먼저 만든다", s: { talk: 2, like: 1 } },
        { t: "신중하게 관찰한다", s: { vibe: 2 } },
      ]},
      { q: "갈등이 생겼을 때 가장 가까운 대응은?", a: [
        { t: "바로 대화를 제안한다", s: { talk: 2, like: 1 } },
        { t: "시간을 두고 정리한다", s: { vibe: 2 } },
        { t: "핵심만 짧게 전달한다", s: { talk: 1, chaos: 1 } },
        { t: "상대 감정을 먼저 챙긴다", s: { like: 2 } },
      ]},
      { q: "단체 대화방에서 나의 포지션은?", a: [
        { t: "분위기 메이커", s: { chaos: 2, talk: 1 } },
        { t: "요약 정리 담당", s: { talk: 2, vibe: 1 } },
        { t: "필요할 때만 정확히 답한다", s: { vibe: 2 } },
        { t: "공감 리액션 담당", s: { like: 2 } },
      ]},
      { q: "플러팅 스타일에 가까운 것은?", a: [
        { t: "말로 자연스럽게 호감 표시", s: { talk: 2 } },
        { t: "배려 행동으로 보여준다", s: { like: 2 } },
        { t: "분위기와 표정으로 전달", s: { vibe: 2 } },
        { t: "가볍고 유쾌하게 직진", s: { chaos: 2, talk: 1 } },
      ]},
      { q: "약속 장소를 정할 때 나는?", a: [
        { t: "후보를 여러 개 제시", s: { talk: 2, vibe: 1 } },
        { t: "상대 취향을 먼저 묻는다", s: { like: 2 } },
        { t: "분위기 좋은 곳 하나를 고른다", s: { vibe: 2 } },
        { t: "가볍고 새로운 곳 시도", s: { chaos: 2 } },
      ]},
      { q: "상대에게 가장 강조하고 싶은 내 매력은?", a: [
        { t: "대화가 편하다는 점", s: { talk: 2, like: 1 } },
        { t: "배려와 안정감", s: { like: 2, vibe: 1 } },
        { t: "분위기와 감각", s: { vibe: 2 } },
        { t: "재미와 에너지", s: { chaos: 2 } },
      ]},
      { q: "주말 데이트를 고른다면?", a: [
        { t: "대화 중심 카페/전시", s: { talk: 2, vibe: 1 } },
        { t: "편안한 산책과 식사", s: { like: 2 } },
        { t: "사진이 잘 나오는 장소", s: { vibe: 2 } },
        { t: "즉흥 코스 투어", s: { chaos: 2, talk: 1 } },
      ]},
      { q: "연락 템포는 보통 어떤 편인가요?", a: [
        { t: "빠르게 답장하는 편", s: { talk: 1, chaos: 1 } },
        { t: "상대 흐름에 맞춘다", s: { like: 2 } },
        { t: "생각 정리 후 답장", s: { vibe: 2 } },
        { t: "짧고 핵심적으로 답장", s: { talk: 2 } },
      ]},
      { q: "오늘의 나를 한 줄로 표현하면?", a: [
        { t: "차분하지만 존재감 있는 타입", s: { vibe: 2 } },
        { t: "대화로 분위기를 이끄는 타입", s: { talk: 2 } },
        { t: "배려와 공감이 강점인 타입", s: { like: 2 } },
        { t: "유쾌하고 변수가 있는 타입", s: { chaos: 2 } },
      ]},
    ];

    const CHARACTERS = [
      { id: "YS_PRO", label: "프로형 영수", base: "영수", profile: "대화 구조를 잘 만들고 흐름을 잡는 타입", need: "핵심을 짧게 정리하면 더 강해져요.", good: ["주도력", "설득력"], bad: ["장황해질 수 있음"], keyDims: { talk: 2, vibe: 1 } },
      { id: "YH_SAFE", label: "안정형 영호", base: "영호", profile: "속도 조절과 신뢰 구축이 강점인 타입", need: "가끔은 먼저 제안해도 좋아요.", good: ["신중함", "신뢰"], bad: ["기회가 늦어질 수 있음"], keyDims: { like: 2, vibe: 1 } },
      { id: "OS_AURA", label: "아우라형 옥순", base: "옥순", profile: "분위기와 감각으로 인상을 남기는 타입", need: "의도를 말로 한 번 더 설명해보세요.", good: ["존재감", "감각"], bad: ["거리감으로 보일 수 있음"], keyDims: { vibe: 2, like: 1 } },
      { id: "YC_CARE", label: "케어형 영철", base: "영철", profile: "상대 감정을 읽고 안정적으로 반응하는 타입", need: "내 취향도 분명히 표현해보세요.", good: ["공감", "배려"], bad: ["자기표현 부족"], keyDims: { like: 2, talk: 1 } },
      { id: "SJ_SPICY", label: "에너지형 순자", base: "순자", profile: "유쾌하고 빠른 템포로 분위기를 띄우는 타입", need: "속도 조절을 하면 호감도가 더 올라갑니다.", good: ["유쾌함", "활동성"], bad: ["급하게 보일 수 있음"], keyDims: { chaos: 2, talk: 1 } },
      { id: "HS_SOFT", label: "무해형 현숙", base: "현숙", profile: "편안하고 안정적인 대화가 강한 타입", need: "인상 깊은 포인트를 하나 추가해보세요.", good: ["편안함", "안정감"], bad: ["임팩트 부족"], keyDims: { like: 2 } },
    ];

    let STATE = {
      modeRandom: false,
      quiz: null,
      idx: 0,
      scores: {},
      answers: [],
      lastResult: null,
      photoDataUrl: null,
    };

    function showToast(message) {
      els.toast.textContent = message;
      els.toast.classList.add("show");
      setTimeout(() => els.toast.classList.remove("show"), 1600);
    }

    function showModal(modal) {
      modal.classList.add("show");
      modal.setAttribute("aria-hidden", "false");
    }

    function hideModal(modal) {
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (ch) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[ch]));
    }

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    function daySeed() {
      const now = new Date();
      const bucket = Math.floor((now.getHours() * 60 + now.getMinutes()) / 20);
      return (now.getFullYear() * 10000 + (now.getMonth() + 1) * 100 + now.getDate()) * 97 + bucket * 131;
    }

    function mulberry32(seed) {
      return function () {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function initAds() {
      const slots = $$("ins.adsbygoogle");
      slots.forEach((slot) => {
        if (slot.dataset.adsInitialized === "1") return;
        try {
          (adsbygoogle = window.adsbygoogle || []).push({});
          slot.dataset.adsInitialized = "1";
        } catch (_) {
          // 로컬 개발 환경에서 ads script 미응답 시 무시
        }
      });
    }

    function hintFor(scores) {
      const labels = [];
      if (scores.chaos) labels.push("유쾌함");
      if (scores.talk) labels.push("대화력");
      if (scores.like) labels.push("호감도");
      if (scores.vibe) labels.push("분위기");
      return labels.join(" · ");
    }

    function initQuiz() {
      STATE.quiz = QUESTIONS;
      STATE.idx = 0;
      STATE.answers = [];
      STATE.scores = { chaos: 0, like: 0, talk: 0, vibe: 0 };
      renderQuiz();
    }

    function renderQuiz() {
      els.viewLanding.classList.add("hide");
      els.viewResult.classList.add("hide");
      els.viewQuiz.classList.remove("hide");

      const total = STATE.quiz.length;
      const i = STATE.idx;
      const q = STATE.quiz[i];

      els.qIndex.textContent = String(i + 1);
      els.qTotal.textContent = String(total);
      els.qProg.style.width = `${Math.round((i / total) * 100)}%`;

      els.qText.textContent = q.q;
      els.answers.innerHTML = "";

      q.a.forEach((opt) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "ans";
        button.innerHTML = `${escapeHtml(opt.t)}<small>${escapeHtml(hintFor(opt.s))}</small>`;
        button.addEventListener("click", () => chooseAnswer(opt));
        els.answers.appendChild(button);
      });

      $("#adMid").style.display = i >= 3 ? "block" : "none";
      initAds();
    }

    function chooseAnswer(opt) {
      Object.entries(opt.s || {}).forEach(([k, v]) => {
        STATE.scores[k] = (STATE.scores[k] || 0) + v;
      });

      STATE.answers.push(opt);
      STATE.idx += 1;

      if (STATE.idx >= STATE.quiz.length) {
        finishQuiz();
      } else {
        renderQuiz();
      }
    }

    function pickCharacter(weightedDims) {
      const weight = { chaos: 1.15, like: 1.0, talk: 1.05, vibe: 1.0 };
      let best = null;

      CHARACTERS.forEach((ch) => {
        const target = {
          chaos: (ch.keyDims.chaos || 0) * 4,
          like: (ch.keyDims.like || 0) * 4,
          talk: (ch.keyDims.talk || 0) * 4,
          vibe: (ch.keyDims.vibe || 0) * 4,
        };

        const dist =
          weight.chaos * Math.abs(weightedDims.chaos - target.chaos) +
          weight.like * Math.abs(weightedDims.like - target.like) +
          weight.talk * Math.abs(weightedDims.talk - target.talk) +
          weight.vibe * Math.abs(weightedDims.vibe - target.vibe);

        const score = -dist + (Math.random() * 0.4 - 0.2);
        if (!best || score > best.score) best = { score, ch };
      });

      return best.ch;
    }

    function gradeFrom(chaos, like, talk, vibe) {
      const score = like * 0.3 + talk * 0.27 + vibe * 0.27 + chaos * 0.16;
      if (score >= 78) return "LEGEND";
      if (score >= 66) return "PRO";
      if (score >= 54) return "NICE";
      if (score >= 42) return "MEME";
      return "CHAOS";
    }

    function buildResultText(res) {
      const nameText = res.nickname ? `${res.nickname}님의` : "당신의";
      return [
        `나는솔로 스타일 캐릭터 테스트 결과`,
        `${nameText} 결과: ${res.grade} ${res.character.label}`,
        `혼돈 ${res.dims.chaos} / 호감 ${res.dims.like} / 대화 ${res.dims.talk} / 분위기 ${res.dims.vibe}`,
        `요약: ${res.character.profile}`,
        `한 줄 팁: ${res.character.need}`,
      ].join("\n");
    }

    function finishQuiz() {
      const mixBase = Number(els.randMix.value || 30) / 100;
      const mix = STATE.modeRandom ? clamp(mixBase + 0.1, 0.1, 0.5) : mixBase;
      const memeLevel = els.memeLevel.value;

      const base = { ...STATE.scores };
      const seeded = mulberry32(daySeed() + Math.floor(Math.random() * 9999));
      const noise = {
        chaos: (seeded() * 2 - 1) * 2,
        like: (seeded() * 2 - 1) * 2,
        talk: (seeded() * 2 - 1) * 2,
        vibe: (seeded() * 2 - 1) * 2,
      };

      const blended = {};
      Object.keys(base).forEach((k) => {
        blended[k] = base[k] * (1 - mix) + (base[k] + noise[k]) * mix;
      });

      if (memeLevel === "SAFE") blended.chaos -= 0.4;
      if (memeLevel === "CHAOS") blended.chaos += 0.8;

      const character = pickCharacter(blended);

      const dims = {
        chaos: clamp(Math.round((blended.chaos + 4) * 12), 0, 100),
        like: clamp(Math.round((blended.like + 4) * 12), 0, 100),
        talk: clamp(Math.round((blended.talk + 4) * 12), 0, 100),
        vibe: clamp(Math.round((blended.vibe + 4) * 12), 0, 100),
      };

      const res = {
        day: TODAY,
        at: Date.now(),
        nickname: String(els.nickname.value || "").trim().slice(0, 18),
        mix: Math.round(mix * 100),
        memeLevel,
        dims,
        grade: gradeFrom(dims.chaos, dims.like, dims.talk, dims.vibe),
        character,
      };

      res.text = buildResultText(res);
      STATE.lastResult = res;

      saveJson(LS_LAST, res);
      saveBest(res);

      els.btnOpenShare.disabled = false;
      els.btnRestart.disabled = false;
      renderResult(res);
    }

    function badgeHtml(grade) {
      if (grade === "LEGEND") return '<span class="badge">LEGEND</span>';
      if (grade === "PRO") return '<span class="badge">PRO</span>';
      if (grade === "NICE") return '<span class="badge">NICE</span>';
      if (grade === "MEME") return '<span class="badge">MEME</span>';
      return '<span class="badge">CHAOS</span>';
    }

    function roastLine(res) {
      const lines = [];
      if (res.dims.chaos > 70) lines.push("에너지가 좋아서 대화의 온도를 빠르게 올리는 편입니다.");
      if (res.dims.talk > 70) lines.push("설명력이 좋아 대화 주도권을 잡기 쉽습니다.");
      if (res.dims.like > 70) lines.push("상대가 편안함을 느끼는 강점이 분명합니다.");
      if (res.dims.vibe > 70) lines.push("분위기 연출 능력이 좋고 첫인상이 선명합니다.");
      if (res.dims.chaos < 35) lines.push("조금 더 적극적인 제스처를 추가하면 매력이 더 보입니다.");
      if (res.dims.talk < 35) lines.push("질문 하나만 더 던져도 대화 밀도가 크게 올라갑니다.");
      if (!lines.length) lines.push("전체 밸런스가 고른 편이라 안정적인 결과입니다.");
      return lines[Math.floor(Math.random() * lines.length)];
    }

    function renderResult(res) {
      els.viewLanding.classList.add("hide");
      els.viewQuiz.classList.add("hide");
      els.viewResult.classList.remove("hide");

      els.resultBadges.innerHTML = `${badgeHtml(res.grade)}<span class="badge">${escapeHtml(res.character.base)}</span><span class="badge">RANDOM ${res.mix}%</span>`;
      els.resultTitle.textContent = `${res.character.label}`;
      els.resultSubtitle.textContent = `${res.character.profile} (오락용 결과)`;

      els.kChaos.textContent = String(res.dims.chaos);
      els.kLike.textContent = String(res.dims.like);
      els.kTalk.textContent = String(res.dims.talk);
      els.kVibe.textContent = String(res.dims.vibe);

      els.resultTips.innerHTML =
        `<strong>해석 가이드</strong><br>` +
        `강점: ${escapeHtml(res.character.good.join(", "))}<br>` +
        `주의: ${escapeHtml(res.character.bad.join(", "))}<br>` +
        `한 줄 팁: ${escapeHtml(res.character.need)}<br><br>` +
        `${escapeHtml(roastLine(res))}`;

      showToast(`결과: ${res.grade} ${res.character.label}`);
      initAds();
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
      if (fill) { ctx.fillStyle = fill; ctx.fill(); }
      if (stroke) { ctx.strokeStyle = stroke; ctx.lineWidth = 2; ctx.stroke(); }
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight, font, fillStyle) {
      ctx.font = font;
      ctx.fillStyle = fillStyle;
      const words = String(text).split(" ");
      let line = "";
      for (let i = 0; i < words.length; i += 1) {
        const candidate = line + words[i] + " ";
        if (ctx.measureText(candidate).width > maxWidth && i > 0) {
          ctx.fillText(line, x, y);
          line = words[i] + " ";
          y += lineHeight;
        } else {
          line = candidate;
        }
      }
      ctx.fillText(line, x, y);
    }

    async function drawShareCard(res) {
      const canvas = els.shareCanvas;
      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0, 0, w, h);

      const grad = ctx.createLinearGradient(0, 0, w, h);
      grad.addColorStop(0, "rgba(121,169,255,0.38)");
      grad.addColorStop(0.55, "rgba(107,227,199,0.24)");
      grad.addColorStop(1, "rgba(255,211,139,0.2)");

      ctx.fillStyle = "#071426";
      ctx.fillRect(0, 0, w, h);
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);

      roundRect(ctx, 56, 56, w - 112, h - 112, 28, "rgba(0,0,0,0.45)", "rgba(255,255,255,0.12)");

      ctx.fillStyle = "rgba(255,255,255,0.93)";
      ctx.font = "900 52px 'Noto Sans KR'";
      ctx.fillText("나는솔로 스타일 캐릭터 테스트", 104, 158);

      ctx.fillStyle = "rgba(255,255,255,0.8)";
      ctx.font = "700 30px 'Noto Sans KR'";
      ctx.fillText(`${res.grade} ${res.character.label}`, 104, 244);

      ctx.font = "600 24px 'Noto Sans KR'";
      ctx.fillText(`혼돈 ${res.dims.chaos} · 호감 ${res.dims.like} · 대화 ${res.dims.talk} · 분위기 ${res.dims.vibe}`, 104, 294);

      wrapText(ctx, `요약: ${res.character.profile}`, 104, 356, 640, 34, "600 24px 'Noto Sans KR'", "rgba(255,255,255,0.82)");
      wrapText(ctx, `팁: ${res.character.need}`, 104, 440, 640, 34, "600 24px 'Noto Sans KR'", "rgba(255,255,255,0.82)");

      ctx.font = "500 18px 'Noto Sans KR'";
      ctx.fillStyle = "rgba(255,255,255,0.62)";
      ctx.fillText("For entertainment only · 사진은 저장하지 않음", 104, 540);

      if (STATE.photoDataUrl) {
        const img = await loadImage(STATE.photoDataUrl);
        const cx = 955;
        const cy = 320;
        const r = 132;

        ctx.save();
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();

        const scale = Math.max((r * 2) / img.width, (r * 2) / img.height);
        const dw = img.width * scale;
        const dh = img.height * scale;
        ctx.drawImage(img, cx - dw / 2, cy - dh / 2, dw, dh);
        ctx.restore();

        ctx.strokeStyle = "rgba(255,255,255,0.2)";
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.arc(cx, cy, r + 1, 0, Math.PI * 2);
        ctx.stroke();
      }
    }

    function loadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    function downloadCanvas(canvas, filename) {
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function saveJson(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (_) {
        showToast("브라우저 저장소에 기록하지 못했습니다.");
      }
    }

    function loadJson(key) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      } catch (_) {
        return null;
      }
    }

    function bestScore(res) {
      return res.dims.like * 0.32 + res.dims.vibe * 0.28 + res.dims.talk * 0.24 + res.dims.chaos * 0.16;
    }

    function saveBest(res) {
      const current = {
        day: TODAY,
        title: `${res.grade} ${res.character.label}`,
        score: bestScore(res),
      };

      const old = loadJson(LS_BEST);
      if (!old || old.day !== TODAY || current.score > old.score) saveJson(LS_BEST, current);
    }

    function loadLastResult() {
      return loadJson(LS_LAST);
    }

    function resetAll() {
      STATE = {
        modeRandom: false,
        quiz: null,
        idx: 0,
        scores: {},
        answers: [],
        lastResult: null,
        photoDataUrl: null,
      };

      els.btnOpenShare.disabled = true;
      els.btnRestart.disabled = true;
      els.viewQuiz.classList.add("hide");
      els.viewResult.classList.add("hide");
      els.viewLanding.classList.remove("hide");
    }

    els.btnHow.addEventListener("click", () => showModal(els.mHow));

    $$("[data-close]").forEach((btn) => {
      btn.addEventListener("click", () => hideModal($(btn.getAttribute("data-close"))));
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        hideModal(els.mHow);
        hideModal(els.mShare);
      }
    });

    els.btnStart.addEventListener("click", initQuiz);
    els.btnStart2.addEventListener("click", initQuiz);
    els.btnTryAgain.addEventListener("click", initQuiz);
    els.btnRestart.addEventListener("click", initQuiz);

    els.btnRandom.addEventListener("click", () => {
      STATE.modeRandom = !STATE.modeRandom;
      els.btnRandom.classList.toggle("primary", STATE.modeRandom);
      showToast(STATE.modeRandom ? "랜덤 강화 활성화" : "랜덤 강화 해제");
    });

    els.btnSkip.addEventListener("click", () => {
      initQuiz();
      const seeded = mulberry32(daySeed());
      for (let i = 0; i < QUESTIONS.length; i += 1) {
        const q = QUESTIONS[i];
        const picked = q.a[Math.floor(seeded() * q.a.length)];
        Object.entries(picked.s || {}).forEach(([k, v]) => {
          STATE.scores[k] = (STATE.scores[k] || 0) + v;
        });
      }
      STATE.idx = QUESTIONS.length;
      finishQuiz();
    });

    els.btnCopyText.addEventListener("click", async () => {
      if (!STATE.lastResult) return;
      try {
        await navigator.clipboard.writeText(STATE.lastResult.text);
        showToast("결과 문구를 복사했습니다.");
      } catch (_) {
        showToast("복사 권한이 없어 실패했습니다.");
      }
    });

    els.btnMakeShare.addEventListener("click", async () => {
      if (!STATE.lastResult) return;
      await drawShareCard(STATE.lastResult);
      showModal(els.mShare);
    });

    els.btnOpenShare.addEventListener("click", async () => {
      if (!STATE.lastResult) {
        const last = loadLastResult();
        if (last) STATE.lastResult = last;
      }
      if (!STATE.lastResult) {
        showToast("먼저 결과를 만들어주세요.");
        return;
      }
      await drawShareCard(STATE.lastResult);
      showModal(els.mShare);
    });

    els.btnDownloadShare.addEventListener("click", async () => {
      if (!STATE.lastResult) return;
      await drawShareCard(STATE.lastResult);
      downloadCanvas(els.shareCanvas, "character-test-share.png");
    });

    els.btnCopyShareText.addEventListener("click", async () => {
      if (!STATE.lastResult) return;
      const msg = [
        "나는솔로 스타일 캐릭터 테스트 결과가 나왔어요.",
        `${STATE.lastResult.grade} ${STATE.lastResult.character.label}`,
        "너도 해보고 결과 비교해보자.",
      ].join("\n");
      try {
        await navigator.clipboard.writeText(msg);
        showToast("공유 문구를 복사했습니다.");
      } catch (_) {
        showToast("복사에 실패했습니다.");
      }
    });

    els.btnReset.addEventListener("click", () => {
      const ok = window.confirm("저장된 최근 결과와 기록을 삭제할까요?");
      if (!ok) return;
      localStorage.removeItem(LS_BEST);
      localStorage.removeItem(LS_LAST);
      resetAll();
      showToast("저장 데이터를 초기화했습니다.");
    });

    els.photoInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        STATE.photoDataUrl = null;
        return;
      }

      const allowed = ["image/png", "image/jpeg", "image/webp"];
      if (!allowed.includes(file.type)) {
        e.target.value = "";
        showToast("PNG/JPG/WEBP 파일만 업로드할 수 있습니다.");
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        e.target.value = "";
        showToast("파일 크기는 5MB 이하만 가능합니다.");
        return;
      }

      try {
        STATE.photoDataUrl = await fileToDataUrl(file);
        showToast("사진을 불러왔습니다.");
      } catch (_) {
        showToast("사진 처리 중 오류가 발생했습니다.");
      }
    });

    function boot() {
      resetAll();
      const last = loadLastResult();
      if (last) {
        STATE.lastResult = last;
        els.btnOpenShare.disabled = false;
        els.btnRestart.disabled = false;
      }
      initAds();
    }

    boot();
  </script>
</body>
</html>
