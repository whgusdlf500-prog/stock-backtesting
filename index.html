<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>í€€íŠ¸ ì•„ì¼€ì´ë“œ â€” ê²Œì„í˜• ë°±í…ŒìŠ¤í„°</title>
  <meta name="description" content="ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì²˜ë¦¬ë˜ëŠ” ê²Œì„í˜• ë°±í…ŒìŠ¤í„°. ì „ëµ ë£°ë ›, ë“±ê¸‰, ê¸°ë¡, ê³µìœ  ì¹´ë“œê¹Œì§€."/>
  <style>
    :root{
      --bg:#070A14;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.12);
      --text:#EAF0FF;
      --sub:#AAB6D6;
      --good:#35F0B5;
      --bad:#FF5B7A;
      --mid:#6D7CFF;
      --gold:#FFD36E;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
      --r: 20px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(109,124,255,.22), transparent 55%),
        radial-gradient(900px 700px at 90% 10%, rgba(53,240,181,.16), transparent 55%),
        radial-gradient(800px 520px at 50% 120%, rgba(255,211,110,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), #040610 70%);
      overflow-x:hidden;
    }
    a{ color:inherit; }
    .wrap{ max-width:1200px; margin:0 auto; padding: 18px 16px 34px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding: 14px 14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 210deg, rgba(109,124,255,.95), rgba(53,240,181,.90), rgba(255,211,110,.88), rgba(109,124,255,.95));
      box-shadow: 0 10px 30px rgba(109,124,255,.22);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:9px;
      border-radius:12px;
      background: rgba(8,10,20,.78);
      border:1px solid rgba(255,255,255,.10);
    }
    .bt{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:800;
      cursor:pointer;
      transition:.15s transform,.15s background,.15s border-color;
      user-select:none;
      white-space:nowrap;
    }
    .bt:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22); }
    .bt.primary{
      background: linear-gradient(90deg, rgba(109,124,255,.28), rgba(53,240,181,.18));
      border-color: rgba(109,124,255,.55);
    }
    .bt.gold{
      background: linear-gradient(90deg, rgba(255,211,110,.28), rgba(109,124,255,.16));
      border-color: rgba(255,211,110,.52);
    }
    .bt.danger{
      background: rgba(255,91,122,.12);
      border-color: rgba(255,91,122,.45);
    }
    .sub{ color: var(--sub); font-size: 12px; line-height:1.45; margin-top:4px; }
    h1{ font-size:16px; margin:0; letter-spacing:-.02em; }
    .grid{
      margin-top:14px;
      display:grid; gap:14px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.00));
    }
    .hd .title{ font-weight:900; font-size:13px; letter-spacing:-.01em; }
    .hd .hint{ color:var(--sub); font-size:12px; margin-top:6px; line-height:1.45; }
    .bd{ padding: 14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:6px; min-width: 180px; }
    label{ font-size:12px; color:var(--sub); }
    .in, select, textarea{
      background: rgba(7,10,20,.62);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
    }
    textarea{ min-height: 120px; resize: vertical; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      margin: 6px 6px 0 0;
    }
    .dot{ width:9px; height:9px; border-radius:999px; background: var(--good); }
    .dot.mid{ background: var(--mid); }
    .dot.gold{ background: var(--gold); }

    .kpi{
      display:grid; gap:10px;
      grid-template-columns: repeat(4, 1fr);
    }
    @media (max-width: 980px){ .kpi{ grid-template-columns: repeat(2, 1fr); } }
    .tile{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding: 12px;
    }
    .tile .t{ color:var(--sub); font-size:11px; }
    .tile .v{ font-size:16px; font-weight:950; margin-top:6px; letter-spacing:-.02em; }

    canvas{
      width:100%;
      height:340px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(4,6,16,.55);
    }

    .meter{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .meter > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(109,124,255,.9), rgba(53,240,181,.9), rgba(255,211,110,.85));
      transition: width .12s linear;
    }

    table{ width:100%; border-collapse: collapse; font-size:12px; }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      text-align:left;
      vertical-align: top;
    }
    th{ color: var(--sub); font-weight:900; }
    tr:hover td{ background: rgba(255,255,255,.04); }

    .adslot{
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 14px;
      color: var(--sub);
      font-size: 12px;
      line-height:1.5;
    }
    .adslot b{ color: var(--text); }

    .modal{
      position:fixed; inset:0;
      display:none;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      padding: 16px;
      z-index: 50;
    }
    .modal.show{ display:flex; align-items:center; justify-content:center; }
    .modal .box{
      width: min(820px, 96vw);
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .box .mh{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .modal .box .mb{ padding: 14px; color: var(--sub); line-height:1.65; font-size: 13px; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; font-weight:950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      margin-right: 8px;
    }
    .badge.good{ border-color: rgba(53,240,181,.45); background: rgba(53,240,181,.10); color: var(--good); }
    .badge.bad{ border-color: rgba(255,91,122,.45); background: rgba(255,91,122,.10); color: var(--bad); }
    .badge.gold{ border-color: rgba(255,211,110,.50); background: rgba(255,211,110,.10); color: var(--gold); }
    .tiny{ font-size:12px; color: var(--sub); }
    .rightStack{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ color: var(--sub); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>í€€íŠ¸ ì•„ì¼€ì´ë“œ <span class="muted">â€” ê²Œì„í˜• ë°±í…ŒìŠ¤í„°</span></h1>
          <div class="sub">âœ… ì„œë²„ëŠ” <b>ê´‘ê³ +UIë§Œ</b> ì œê³µ Â· âœ… ê°€ê²© ë°ì´í„°ëŠ” <b>ë¸Œë¼ìš°ì €ì—ì„œë§Œ</b> ì²˜ë¦¬ Â· âœ… â€œë£°ë ›â†’ë“±ê¸‰â†’ê¸°ë¡â†’ê³µìœ â€ ë£¨í”„ë¡œ ì²´ë¥˜ì‹œê°„ ê·¹ëŒ€í™”</div>
        </div>
      </div>
      <div class="rightStack">
        <button class="bt" id="btnHow">ì‚¬ìš©ë²•</button>
        <button class="bt gold" id="btnShare">ê³µìœ  ì¹´ë“œ ë§Œë“¤ê¸°</button>
        <button class="bt danger" id="btnReset">ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div style="margin-top:14px;" class="adslot">
      <b>ê´‘ê³  ìŠ¬ë¡¯ (ìƒë‹¨)</b><br/>
      Adsense ì½”ë“œ ì‚½ì… ìœ„ì¹˜. (ìƒë‹¨ì€ RPMì— ìœ ë¦¬ / ë‹¨, ì½˜í…ì¸  ê²½í—˜ì„ í•´ì¹˜ì§€ ì•Šê²Œ ë†’ì´ ì œí•œ ê¶Œì¥)
    </div>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <div>
            <div class="title">ğŸ® 1) í”Œë ˆì´ ì‹œì‘ (CSV ì—†ì–´ë„ ë°”ë¡œ ê°€ëŠ¥)</div>
            <div class="hint">
              <span class="pill"><span class="dot gold"></span>ì¦‰ì‹œ í”Œë ˆì´: <b>ë°ëª¨(í•©ì„± ë°ì´í„°)</b></span>
              <span class="pill"><span class="dot mid"></span>ì‹¤ë°ì´í„°: <b>ë³µë¶™</b> ë˜ëŠ” <b>CSV</b></span>
              <span class="pill"><span class="dot"></span>ê²°ê³¼ëŠ” <b>ë“±ê¸‰</b>ìœ¼ë¡œ ì—°ì¶œ</span>
            </div>
          </div>
          <div class="row">
            <button class="bt" id="btnDemo">ë°ëª¨ë¡œ ì¦‰ì‹œ í”Œë ˆì´</button>
            <button class="bt primary" id="btnSpin">ğŸ² ì „ëµ ë£°ë ›</button>
            <button class="bt gold" id="btnRun">ğŸš€ ë°±í…ŒìŠ¤íŠ¸</button>
          </div>
        </div>

        <div class="bd">
          <div class="row">
            <div class="col" style="min-width:260px;">
              <label>ì„¸ì…˜ ì´ë¦„ (ê¸°ë¡/ê³µìœ ì— í‘œì‹œ)</label>
              <input class="in" id="sessionName" placeholder="ì˜ˆ: AAPL / ì‚¼ì„±ì „ì / ë‚´ ì „ëµ ì‹¤í—˜" />
            </div>
            <div class="col">
              <label>ëª¨ë“œ</label>
              <select id="mode">
                <option value="DEMO">ë°ëª¨(í•©ì„± ë°ì´í„°, ì¦‰ì‹œ ì‹¤í–‰)</option>
                <option value="PASTE">ë³µë¶™(í‘œ/CSV í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°)</option>
                <option value="CSV">CSV ì—…ë¡œë“œ</option>
              </select>
            </div>
            <div class="col">
              <label>ë°ì´í„° ìºì‹œ</label>
              <select id="cacheMode">
                <option value="ON">ON (ë‹¤ìŒì— ë” ë¹ ë¦„)</option>
                <option value="OFF">OFF</option>
              </select>
            </div>
            <div class="col">
              <label>ì†ë„</label>
              <select id="speed">
                <option value="FAST">ë¹ ë¦„(ê´‘ê³  ë…¸ì¶œ ë£¨í”„ ìœ ë¦¬)</option>
                <option value="SHOW">ì—°ì¶œ(ì°¨íŠ¸ ì¬ìƒ)</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px;" id="inputArea"></div>

          <div style="margin-top:12px;">
            <div class="row" style="justify-content:space-between;">
              <div class="row">
                <span class="pill"><span class="dot"></span>ì¢…ê°€</span>
                <span class="pill"><span class="dot mid"></span>ì§€í‘œ(ì „ëµ)</span>
                <span class="pill"><span class="dot gold"></span>ë“±ê¸‰/ê¸°ë¡</span>
              </div>
              <div class="tiny">â€» ë°ì´í„°ëŠ” ì´ í˜ì´ì§€ì—ì„œë§Œ ì²˜ë¦¬ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•Šë„ë¡ ì„¤ê³„ë¨</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="meter" aria-label="simulation progress"><div id="prog"></div></div>
          </div>

          <div style="margin-top:12px;">
            <canvas id="chart" width="1200" height="620"></canvas>
          </div>

          <div style="margin-top:12px;" class="kpi">
            <div class="tile"><div class="t">ë“±ê¸‰</div><div class="v" id="kGrade">-</div></div>
            <div class="tile"><div class="t">ì´ ìˆ˜ìµë¥ </div><div class="v" id="kRet">-</div></div>
            <div class="tile"><div class="t">ìµœëŒ€ë‚™í­(MDD)</div><div class="v" id="kMdd">-</div></div>
            <div class="tile"><div class="t">ì˜¤ëŠ˜ ìµœê³ </div><div class="v" id="kBest">-</div></div>
          </div>

          <div style="margin-top:14px;" class="adslot">
            <b>ê´‘ê³  ìŠ¬ë¡¯ (ì¤‘ê°„)</b><br/>
            ê²°ê³¼ í™•ì¸ í›„ ì‹œì„ ì´ ë‚´ë ¤ì˜¤ëŠ” ì§€ì . â€œë£°ë ›â†’ì‹¤í–‰â†’ê²°ê³¼â€ ë°˜ë³µ ë£¨í”„ì—ì„œ ë°˜ë³µ ë…¸ì¶œì´ ì˜ ë©ë‹ˆë‹¤.
          </div>

        </div>
      </section>

      <aside class="card">
        <div class="hd">
          <div>
            <div class="title">ğŸ§  2) ì „ëµ & ê¸°ë¡ (ì¤‘ë… ë£¨í”„)</div>
            <div class="hint">ë£°ë ›ìœ¼ë¡œ ì „ëµì„ ë°”ê¾¸ê³ , ê¸°ë¡ì„ ê¹¨ê³ , ê³µìœ  ì¹´ë“œë¡œ í¼ëœ¨ë¦¬ëŠ” êµ¬ì¡°.</div>
          </div>
          <div class="row">
            <button class="bt" id="btnAI">ğŸ¤– AI ì¶”ì²œ</button>
            <button class="bt" id="btnSave">ê¸°ë¡ ì €ì¥</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div class="col">
              <label>ì „ëµ í”„ë¦¬ì…‹</label>
              <select id="preset"></select>
            </div>
            <div class="col">
              <label>ì´ˆê¸°ìë³¸</label>
              <input class="in" id="cash" type="number" value="1000000" min="1" step="1"/>
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="col">
              <label>ê±°ë˜ë¹„ìš©(ì™•ë³µ, %)</label>
              <input class="in" id="fee" type="number" value="0.10" min="0" step="0.01"/>
            </div>
            <div class="col">
              <label>ìŠ¬ë¦¬í”¼ì§€(í¸ë„, %)</label>
              <input class="in" id="slip" type="number" value="0.03" min="0" step="0.01"/>
            </div>
          </div>

          <div style="margin-top:10px;" class="row">
            <div class="col" style="min-width: 100%;">
              <label>ì „ëµ ì„¤ëª…</label>
              <div class="adslot" id="presetDesc" style="border-style:solid; border-color: rgba(255,255,255,.10);">-</div>
            </div>
          </div>

          <div style="margin-top:12px; grid-template-columns: repeat(2, 1fr);" class="kpi">
            <div class="tile"><div class="t">ê±°ë˜ ìˆ˜</div><div class="v" id="kTrades">-</div></div>
            <div class="tile"><div class="t">ìŠ¹ë¥ </div><div class="v" id="kWin">-</div></div>
          </div>

          <div style="margin-top:12px;">
            <div class="row" style="justify-content:space-between;">
              <div class="title" style="font-size:13px; font-weight:950;">ğŸ“œ ê±°ë˜ ë¡œê·¸</div>
              <button class="bt" id="btnExport">ê±°ë˜ë‚´ì—­ CSV</button>
            </div>
            <div style="margin-top:10px; max-height: 360px; overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th style="width:110px;">ì¼ì</th>
                    <th>ì´ë²¤íŠ¸</th>
                    <th style="width:110px;">ê°€ê²©</th>
                    <th style="width:120px;">ìì‚°</th>
                  </tr>
                </thead>
                <tbody id="log">
                  <tr><td colspan="4" class="muted">ì•„ì§ ì‹¤í–‰ ì „. ë£°ë › ëŒë¦¬ê³  ğŸš€ ëˆŒëŸ¬ë´.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div style="margin-top:12px;" class="adslot">
            <b>ê´‘ê³  ìŠ¬ë¡¯ (ì‚¬ì´ë“œ/í•˜ë‹¨)</b><br/>
            ë¡±í…Œì¼ ì²´ë¥˜ì— ìœ ë¦¬. ë¡œê·¸ ìŠ¤í¬ë¡¤ ì¤‘ì—ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë…¸ì¶œë©ë‹ˆë‹¤.
          </div>

          <div style="margin-top:12px;" class="tiny">
            <span class="badge">âš–ï¸ ë²•ì  ë¦¬ìŠ¤í¬ ìµœì†Œ ì„¤ê³„</span>
            <div class="muted">
              ë³¸ ì„œë¹„ìŠ¤ëŠ” íˆ¬ììë¬¸ì´ ì•„ë‹ˆë©°, ì‚¬ìš©ìê°€ ì…ë ¥/ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ê³„ì‚°í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
              ì‹œì¥ ë°ì´í„°ëŠ” ì„œë²„ì— ì €ì¥/ì œê³µë˜ì§€ ì•Šë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="modal" id="mHow">
    <div class="box">
      <div class="mh">
        <div>
          <div style="font-weight:950;">ì‚¬ìš©ë²• (ì´íƒˆ ìµœì†Œ ë£¨íŠ¸)</div>
          <div class="tiny">1) ë°ëª¨ë¡œ ì¬ë¯¸ ë¨¼ì € â†’ 2) ì‹¤ë°ì´í„°ëŠ” â€œë³µë¶™â€ì´ ì œì¼ í¸í•¨ â†’ 3) ê¸°ë¡/ê³µìœ ë¡œ ë°˜ë³µ</div>
        </div>
        <button class="bt" data-close="#mHow">ë‹«ê¸°</button>
      </div>
      <div class="mb">
        <div class="badge gold">ì¶”ì²œ ë£¨íŠ¸</div>
        <b>ë°ëª¨(í•©ì„±)</b>ë¡œ ì¦‰ì‹œ í”Œë ˆì´ â†’ ì „ëµ ë£°ë › â†’ ë“±ê¸‰/ê¸°ë¡ â†’ ì¬ë¯¸ ë¶™ìœ¼ë©´ <b>ë³µë¶™(í‘œ/CSV í…ìŠ¤íŠ¸)</b>ë¡œ ì‹¤ë°ì´í„° ì „í™˜.<br/><br/>
        <div class="badge good">ë³µë¶™ íŒ</div>
        ì£¼ê°€ í‘œë¥¼ â€œë³µì‚¬(í´ë¦½ë³´ë“œ)â€í•´ì„œ ë¶™ì—¬ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤. ì•„ë˜ í˜•ì‹ì´ë©´ OK:<br/>
        <div class="adslot" style="border-style:solid; border-color: rgba(255,255,255,.10); margin-top:8px;">
          date,close<br/>
          2024-01-02,104<br/>
          2024-01-03,102
        </div><br/>
        <div class="badge">ë¦¬ìŠ¤í¬ ìµœì†Œí™”</div>
        ì„œë²„ê°€ ê°€ê²© ë°ì´í„°ë¥¼ ì €ì¥/ë°°í¬í•˜ì§€ ì•Šê³ , ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì²˜ë¦¬ë˜ë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <div class="modal" id="mShare">
    <div class="box">
      <div class="mh">
        <div>
          <div style="font-weight:950;">ê³µìœ  ì¹´ë“œ (ë°”ì´ëŸ´ ì¥ì¹˜)</div>
          <div class="tiny">ê²°ê³¼ë¥¼ ì´ë¯¸ì§€ì²˜ëŸ¼ ì €ì¥/ê³µìœ í•˜ë©´ ìœ ì…ì´ ëŠ˜ê³ , Adsense ìˆ˜ìµì´ ê°™ì´ ì»¤ì§‘ë‹ˆë‹¤.</div>
        </div>
        <button class="bt" data-close="#mShare">ë‹«ê¸°</button>
      </div>
      <div class="mb">
        <canvas id="shareCanvas" width="1200" height="630" style="width:100%; height:auto; border-radius:18px; border:1px solid rgba(255,255,255,.10); background: rgba(4,6,16,.55);"></canvas>
        <div class="row" style="margin-top:10px;">
          <button class="bt gold" id="btnCopyShare">ì´ë¯¸ì§€ë¡œ ì €ì¥(ë‹¤ìš´ë¡œë“œ)</button>
          <span class="tiny muted">â€» ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œë¡œ ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

const els = {
  mode: $("#mode"),
  cacheMode: $("#cacheMode"),
  speed: $("#speed"),
  inputArea: $("#inputArea"),
  sessionName: $("#sessionName"),
  preset: $("#preset"),
  presetDesc: $("#presetDesc"),
  cash: $("#cash"),
  fee: $("#fee"),
  slip: $("#slip"),
  prog: $("#prog"),

  btnHow: $("#btnHow"),
  btnDemo: $("#btnDemo"),
  btnSpin: $("#btnSpin"),
  btnAI: $("#btnAI"),
  btnRun: $("#btnRun"),
  btnSave: $("#btnSave"),
  btnShare: $("#btnShare"),
  btnReset: $("#btnReset"),
  btnExport: $("#btnExport"),

  chart: $("#chart"),
  log: $("#log"),

  kGrade: $("#kGrade"),
  kRet: $("#kRet"),
  kMdd: $("#kMdd"),
  kTrades: $("#kTrades"),
  kWin: $("#kWin"),
  kBest: $("#kBest"),

  mHow: $("#mHow"),
  mShare: $("#mShare"),
  shareCanvas: $("#shareCanvas"),
  btnCopyShare: $("#btnCopyShare"),
};

let STATE = {
  bars: [],
  equity: [],
  trades: [],
  result: null,
  lastStrategy: null,
  bestToday: null,
};

const LS_KEY = "qa_best_today_v1";
const LS_CACHE = "qa_cached_dataset_v1";
const TODAY = new Date().toISOString().slice(0,10);

function loadBest(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(obj?.day !== TODAY) return null;
    return obj;
  } catch { return null; }
}
function saveBest(obj){
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}
function wipeAll(){
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_CACHE);
}

const PRESETS = [
  { id:"MA_20_60", name:"MA í¬ë¡œìŠ¤ (20/60)", desc:"ë¹ ë¥¸ì„ ì´ ëŠë¦°ì„ ì„ ìœ„ë¡œ ëŒíŒŒí•˜ë©´ ë§¤ìˆ˜, ì•„ë˜ë¡œ ë‚´ë ¤ê°€ë©´ ë§¤ë„. ê°€ì¥ ì§ê´€ì ì¸ ì „ëµ.", type:"MA", p:{s:20,l:60} },
  { id:"MA_10_30", name:"MA í¬ë¡œìŠ¤ (10/30) â€” ê³µê²©ì ", desc:"ì§§ì€ MAë¡œ ì‹ í˜¸ê°€ ë§ì•„ ê²Œì„ì„±ì´ í¼. ëŒ€ì‹  í”ë“¤ë¦´ í™•ë¥ ë„ ì¦ê°€.", type:"MA", p:{s:10,l:30} },
  { id:"MOM_120", name:"ëª¨ë©˜í…€ (120ì¼) â€” ì¶”ì„¸ì¶”ì¢…", desc:"ìµœê·¼ 120ì¼ ìˆ˜ìµë¥ ì´ 0ë³´ë‹¤ í¬ë©´ ë³´ìœ , ì•„ë‹ˆë©´ í˜„ê¸ˆ. ë‹¨ìˆœí•˜ì§€ë§Œ ê°•ë ¥í•œ íƒ€ì….", type:"MOM", p:{n:120} },
  { id:"RSI_14_REV", name:"RSI ë°˜ì „ (14) â€” ë°˜ë“± ì‚¬ëƒ¥", desc:"RSIê°€ ë‚®ì„ ë•Œ(ê³¼ë§¤ë„) ì§„ì…, ë†’ì„ ë•Œ(ê³¼ë§¤ìˆ˜) ì²­ì‚°. ì„±í–¥ì´ ì •ë°˜ëŒ€ë¼ ë¹„êµ ì¬ë¯¸ê°€ í¼.", type:"RSI", p:{n:14, buy:30, sell:65} },
  { id:"BREAK_55", name:"ëŒíŒŒ (55ì¼) â€” í„°ì§€ë©´ ê°„ë‹¤", desc:"ìµœê·¼ 55ì¼ ê³ ì  ëŒíŒŒ ì‹œ ë§¤ìˆ˜, 20ì¼ ì €ì  ì´íƒˆ ì‹œ ì²­ì‚°. â€˜ëŒ€ë°•/ìª½ë°•â€™ ì—°ì¶œì— ìµœê³ .", type:"BREAK", p:{hi:55, lo:20} },
];

function setPresets(){
  els.preset.innerHTML = "";
  for(const p of PRESETS){
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.name;
    els.preset.appendChild(opt);
  }
  els.preset.value = PRESETS[0].id;
  updatePresetDesc();
}
function getPreset(){ return PRESETS.find(x=>x.id===els.preset.value) || PRESETS[0]; }
function updatePresetDesc(){ const p = getPreset(); els.presetDesc.textContent = p.desc; STATE.lastStrategy = p; }

function renderInputArea(){
  const m = els.mode.value;
  if(m === "DEMO"){
    els.inputArea.innerHTML = `<div class="adslot" style="border-style:solid; border-color: rgba(255,255,255,.10);"><b>ë°ëª¨(í•©ì„± ë°ì´í„°)</b><br/>ì§€ê¸ˆ ë°”ë¡œ í”Œë ˆì´ìš©. ì‹¤ì œ ì‹œì¥ ë°ì´í„°ë¥¼ ì œê³µí•˜ì§€ ì•Šì•„ì„œ ë²•ì /ìš´ì˜ ë¦¬ìŠ¤í¬ë¥¼ ë‚®ì¶”ê³ , ì‚¬ìš©ìëŠ” ì¬ë¯¸ë¥¼ ë¨¼ì € ëŠë‚ë‹ˆë‹¤.</div>`;
    return;
  }
  if(m === "PASTE"){
    els.inputArea.innerHTML = `<div class="row"><div class="col" style="min-width: 100%;"><label>ë¶™ì—¬ë„£ê¸° (date, close) â€” í‘œë¥¼ ë³µì‚¬í•´ì„œ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„ ë¨</label><textarea id="pasteBox" class="in" placeholder="date,close&#10;2024-01-02,104&#10;2024-01-03,102"></textarea><div class="row" style="margin-top:8px;"><button class="bt" id="btnPasteLoad">ë¶™ì—¬ë„£ê¸° ë°ì´í„° ë¡œë“œ</button><button class="bt" id="btnPasteExample">ì˜ˆì‹œ ë„£ê¸°</button><span class="tiny muted">â€» ì„œë²„ ì „ì†¡ ì—†ìŒ(ë¸Œë¼ìš°ì € ì²˜ë¦¬)</span></div></div></div>`;
    $("#btnPasteLoad").addEventListener("click", ()=> loadFromPaste($("#pasteBox").value));
    $("#btnPasteExample").addEventListener("click", ()=>{
      $("#pasteBox").value = ["date,close","2024-01-02,100","2024-01-03,101","2024-01-04,99","2024-01-05,103","2024-01-08,104","2024-01-09,102"].join("\n");
    });
    return;
  }
  els.inputArea.innerHTML = `<div class="adslot" style="border-style:solid; border-color: rgba(255,255,255,.10);"><b>CSV ì—…ë¡œë“œ (ì˜µì…˜)</b><br/>ìµœì†Œ ì»¬ëŸ¼: <span style="font-family:ui-monospace;">date,close</span><br/><div class="row" style="margin-top:10px;"><input type="file" id="csvFile" accept=".csv,text/csv" class="in" style="padding:10px;"/><button class="bt" id="btnCsvLoad">ì—…ë¡œë“œ ë¡œë“œ</button></div></div>`;
  $("#btnCsvLoad").addEventListener("click", async ()=>{
    const f = $("#csvFile").files?.[0];
    if(!f) return alert("CSV íŒŒì¼ì„ ì„ íƒí•´ì¤˜.");
    const text = await f.text();
    loadFromPaste(text);
  });
}

function parseCSVish(text){
  const lines = text.replace(/\r/g,"").split("\n").map(l=>l.trim()).filter(Boolean);
  if(lines.length < 2) throw new Error("ë°ì´í„°ê°€ ë„ˆë¬´ ì ìŠµë‹ˆë‹¤.");
  const delim = lines[0].includes("\t") && !lines[0].includes(",") ? "\t" : ",";
  const header = lines[0].split(delim).map(s=>s.trim().toLowerCase());
  const iDate = header.indexOf("date");
  const iClose = header.indexOf("close");
  if(iDate === -1 || iClose === -1){
    const rows = [];
    for(const l of lines){
      const parts = l.split(delim).map(s=>s.trim());
      if(parts.length < 2) continue;
      const d = parts[0];
      const c = Number(parts[1].replace(/,/g,""));
      const ts = Date.parse(d);
      if(!isFinite(ts) || !isFinite(c)) continue;
      rows.push({t:ts, date:d, close:c});
    }
    rows.sort((a,b)=>a.t-b.t);
    if(rows.length < 30) throw new Error("ìœ íš¨ ë°ì´í„°ê°€ ë„ˆë¬´ ì ìŠµë‹ˆë‹¤(ìµœì†Œ 30ê°œ ê¶Œì¥).");
    return dedup(rows);
  }

  const rows = [];
  for(let r=1;r<lines.length;r++){
    const parts = lines[r].split(delim).map(s=>s.trim());
    if(parts.length <= Math.max(iDate,iClose)) continue;
    const d = parts[iDate];
    const c = Number(String(parts[iClose]).replace(/,/g,""));
    const ts = Date.parse(d);
    if(!isFinite(ts) || !isFinite(c)) continue;
    rows.push({t:ts, date:d, close:c});
  }
  rows.sort((a,b)=>a.t-b.t);
  if(rows.length < 30) throw new Error("ìœ íš¨ ë°ì´í„°ê°€ ë„ˆë¬´ ì ìŠµë‹ˆë‹¤(ìµœì†Œ 30ê°œ ê¶Œì¥).");
  return dedup(rows);
}
function dedup(rows){
  const out=[];
  let last=null;
  for(const r of rows){
    if(r.t===last) out[out.length-1]=r;
    else out.push(r);
    last=r.t;
  }
  return out;
}

function makeSyntheticBars(len=520){
  const bars=[];
  let p=100;
  let t = Date.now() - len*86400000;
  let drift=0.0003;
  let vol=0.012;
  for(let i=0;i<len;i++){
    if(i%140===0 && i>0){
      drift = (Math.random()*0.0012 - 0.0003);
      vol = 0.008 + Math.random()*0.018;
    }
    const shock = (Math.random()*2-1) * vol;
    p = Math.max(1, p*(1+drift+shock));
    const d = new Date(t + i*86400000);
    const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    bars.push({t: d.getTime(), date: ds, close: Number(p.toFixed(2))});
  }
  return bars;
}

function maybeLoadCache(){
  if(els.cacheMode.value !== "ON") return null;
  try{
    const raw = localStorage.getItem(LS_CACHE);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj?.bars?.length) return null;
    return obj;
  } catch { return null; }
}
function saveCache(name, bars){
  if(els.cacheMode.value !== "ON") return;
  try{ localStorage.setItem(LS_CACHE, JSON.stringify({name, bars, at:Date.now()})); } catch {}
}

function loadDemo(){
  const cached = maybeLoadCache();
  if(cached && cached.name === "DEMO_SYNTH") STATE.bars = cached.bars;
  else { STATE.bars = makeSyntheticBars(620); saveCache("DEMO_SYNTH", STATE.bars); }
  setSessionDefault("DEMO / SYNTH");
  drawChart(STATE.bars, null, null, null);
  toastKpiReset("ë°ëª¨ ë¡œë“œ ì™„ë£Œ");
}
function loadFromPaste(text){
  try{
    const bars = parseCSVish(text);
    STATE.bars = bars;
    saveCache("USER_DATA", bars);
    if(!els.sessionName.value.trim()) els.sessionName.value = "ë‚´ ë°ì´í„°";
    drawChart(STATE.bars, null, null, null);
    toastKpiReset("ë°ì´í„° ë¡œë“œ ì™„ë£Œ");
    els.mode.value = "PASTE";
    renderInputArea();
  } catch(err){ alert("ë¡œë“œ ì‹¤íŒ¨: " + err.message); }
}
function setSessionDefault(name){ if(!els.sessionName.value.trim()) els.sessionName.value = name; }

function sma(arr, n){
  const out = new Array(arr.length).fill(null);
  let sum=0;
  for(let i=0;i<arr.length;i++){
    sum += arr[i];
    if(i>=n) sum -= arr[i-n];
    if(i>=n-1) out[i] = sum/n;
  }
  return out;
}
function rsi(closes, n=14){
  const out = new Array(closes.length).fill(null);
  let gain=0, loss=0;
  for(let i=1;i<closes.length;i++){
    const ch = closes[i]-closes[i-1];
    const g = Math.max(0,ch), l = Math.max(0,-ch);
    if(i<=n){
      gain += g; loss += l;
      if(i===n){
        let rs = loss===0 ? 999 : (gain/n)/(loss/n);
        out[i] = 100 - (100/(1+rs));
      }
    } else {
      gain = (gain*(n-1)+g)/n;
      loss = (loss*(n-1)+l)/n;
      let rs = loss===0 ? 999 : gain/loss;
      out[i] = 100 - (100/(1+rs));
    }
  }
  return out;
}
function rollingMax(arr, n){
  const out = new Array(arr.length).fill(null);
  for(let i=0;i<arr.length;i++){
    if(i<n-1) continue;
    let m=-Infinity;
    for(let k=i-n+1;k<=i;k++) m = Math.max(m, arr[k]);
    out[i]=m;
  }
  return out;
}
function rollingMin(arr, n){
  const out = new Array(arr.length).fill(null);
  for(let i=0;i<arr.length;i++){
    if(i<n-1) continue;
    let m=Infinity;
    for(let k=i-n+1;k<=i;k++) m = Math.min(m, arr[k]);
    out[i]=m;
  }
  return out;
}

function maxDrawdown(eq){
  let peak=-Infinity, mdd=0;
  for(const v of eq){
    if(v>peak) peak=v;
    const dd = (peak - v)/peak;
    if(isFinite(dd) && dd>mdd) mdd=dd;
  }
  return mdd;
}

function fmtPct(x){ if(!isFinite(x)) return "-"; const p = x*100; return (p>=0?"+":"") + p.toFixed(2) + "%"; }
function fmtNum(x){ if(!isFinite(x)) return "-"; return Number(x).toLocaleString("ko-KR", {maximumFractionDigits:0}); }
function gradeFrom(ret, mdd){
  const score = (ret*100) - (mdd*60);
  let grade="TRY";
  if(score >= 180) grade="LEGEND";
  else if(score >= 120) grade="GODMODE";
  else if(score >= 80) grade="PRO";
  else if(score >= 40) grade="NICE";
  else if(score >= 10) grade="OK";
  else if(score >= -10) grade="MEH";
  else grade="RIP";
  return {score, grade};
}

function runBacktest(bars, preset, cfg){
  const closes = bars.map(b=>b.close);
  const feeRound = Math.max(0, cfg.fee/100);
  const slip = Math.max(0, cfg.slip/100);
  const perSideFee = feeRound/2;

  let cash = cfg.cash;
  let qty = 0;
  let inPos = false;

  const eq=[];
  const trades=[];
  let wins=0, losses=0;

  const buy = (i, price, reason)=>{
    const exec = price*(1+slip+perSideFee);
    const buyQty = cash / exec;
    if(buyQty<=0) return;
    qty = buyQty; cash = 0; inPos=true;
    trades.push({date:bars[i].date, type:"BUY", price:exec, equity: cash + qty*price, reason});
  };
  const sell = (i, price, reason, label="SELL")=>{
    const exec = price*(1-slip-perSideFee);
    const proceeds = qty*exec;
    const lastBuy = [...trades].reverse().find(t=>t.type==="BUY");
    if(lastBuy){
      const pnl = (exec-lastBuy.price)/lastBuy.price;
      if(pnl>=0) wins++; else losses++;
    }
    cash += proceeds; qty=0; inPos=false;
    trades.push({date:bars[i].date, type:label, price:exec, equity: cash, reason});
  };
  const mark = (price)=> eq.push(cash + qty*price);

  let aux1=null, aux2=null;
  let readyFrom = 0;

  if(preset.type==="MA"){
    const s = preset.p.s, l = preset.p.l;
    const maS = sma(closes, s);
    const maL = sma(closes, l);
    aux1 = maS; aux2 = maL;
    readyFrom = l;

    for(let i=0;i<bars.length;i++){
      const price = closes[i];
      if(i<readyFrom || maS[i]==null || maL[i]==null || maS[i-1]==null || maL[i-1]==null){ mark(price); continue; }
      const up = (maS[i-1] <= maL[i-1]) && (maS[i] > maL[i]);
      const down = (maS[i-1] >= maL[i-1]) && (maS[i] < maL[i]);

      if(!inPos && up) buy(i, price, `MA ${s}/${l} ê³¨ë“ `);
      if(inPos && down) sell(i, price, `MA ${s}/${l} ë°ë“œ`);
      mark(price);
    }
  } else if(preset.type==="MOM"){
    const n = preset.p.n;
    readyFrom = n;
    for(let i=0;i<bars.length;i++){
      const price = closes[i];
      if(i<readyFrom){ mark(price); continue; }
      const mom = (closes[i] - closes[i-n]) / closes[i-n];
      if(!aux1) aux1 = new Array(bars.length).fill(null);
      aux1[i] = mom;

      if(!inPos && mom>0) buy(i, price, `MOM(${n}) ì–‘ìˆ˜`);
      if(inPos && mom<=0) sell(i, price, `MOM(${n}) ìŒìˆ˜`);
      mark(price);
    }
  } else if(preset.type==="RSI"){
    const n = preset.p.n, b = preset.p.buy, s = preset.p.sell;
    const R = rsi(closes, n);
    aux1 = R;
    readyFrom = n+2;

    for(let i=0;i<bars.length;i++){
      const price = closes[i];
      if(i<readyFrom || R[i]==null){ mark(price); continue; }
      if(!inPos && R[i] <= b) buy(i, price, `RSI<=${b}`);
      if(inPos && R[i] >= s) sell(i, price, `RSI>=${s}`);
      mark(price);
    }
  } else if(preset.type==="BREAK"){
    const hi = preset.p.hi, lo = preset.p.lo;
    const HH = rollingMax(closes, hi);
    const LL = rollingMin(closes, lo);
    aux1 = HH; aux2 = LL;
    readyFrom = Math.max(hi, lo)+2;

    for(let i=0;i<bars.length;i++){
      const price = closes[i];
      if(i<readyFrom || HH[i]==null || LL[i]==null){ mark(price); continue; }
      const breakout = price > HH[i-1];
      const breakdown = price < LL[i-1];

      if(!inPos && breakout) buy(i, price, `${hi}ì¼ ëŒíŒŒ`);
      if(inPos && breakdown) sell(i, price, `${lo}ì¼ ì´íƒˆ`);
      mark(price);
    }
  }

  if(inPos){
    const i = bars.length-1;
    sell(i, closes[i], "ì¢…ë£Œ ì²­ì‚°", "SELL(EOD)");
    eq[eq.length-1] = cash;
  }

  const start = cfg.cash;
  const end = eq[eq.length-1] ?? start;
  const ret = (end-start)/start;
  const mdd = maxDrawdown(eq);
  const tradeCount = trades.filter(t=>t.type.startsWith("SELL")).length;
  const denom = wins+losses;
  const winRate = denom>0 ? wins/denom : 0;

  const g = gradeFrom(ret, mdd);

  return {ret, mdd, tradeCount, winRate, eq, trades, aux1, aux2, score:g.score, grade:g.grade};
}

function drawChart(bars, aux1, aux2, playProgress){
  const c = els.chart;
  const ctx = c.getContext("2d");
  const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);

  const pad={l:58,r:18,t:18,b:46};
  const x0=pad.l, x1=W-pad.r, y0=pad.t, y1=H-pad.b;

  ctx.strokeStyle="rgba(255,255,255,.08)";
  ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=y0+(y1-y0)*i/4;
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
  }
  for(let i=0;i<=6;i++){
    const x=x0+(x1-x0)*i/6;
    ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y1); ctx.stroke();
  }

  if(!bars?.length){
    ctx.fillStyle="rgba(255,255,255,.65)";
    ctx.font="18px ui-sans-serif";
    ctx.fillText("ë°ëª¨ë¡œ ì‹œì‘í•˜ê±°ë‚˜, ë³µë¶™/CSVë¡œ ì‹¤ë°ì´í„°ë¥¼ ë„£ì–´ì¤˜.", x0, (y0+y1)/2);
    return;
  }

  const n = bars.length;
  const lastIndex = (typeof playProgress==="number") ? Math.max(2, Math.floor(playProgress*(n-1))) : (n-1);

  const closes = bars.map(b=>b.close);
  let min = Infinity, max = -Infinity;
  for(let i=0;i<=lastIndex;i++){
    min = Math.min(min, closes[i]);
    max = Math.max(max, closes[i]);
    if(aux1 && aux1[i]!=null && presetIsOverlayPrice()){ min = Math.min(min, aux1[i]); max = Math.max(max, aux1[i]); }
    if(aux2 && aux2[i]!=null && presetIsOverlayPrice()){ min = Math.min(min, aux2[i]); max = Math.max(max, aux2[i]); }
  }
  const padY=(max-min)*0.08 || 1;
  min-=padY; max+=padY;

  const xAt = (i)=> x0 + (x1-x0) * (i/(n-1));
  const yAt = (v)=> y1 - (y1-y0) * ((v-min)/(max-min));

  ctx.strokeStyle="rgba(53,240,181,.95)";
  ctx.lineWidth=2.2;
  ctx.beginPath();
  for(let i=0;i<=lastIndex;i++){
    const x=xAt(i), y=yAt(closes[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  const preset = getPreset();
  if(preset.type==="MA" || preset.type==="BREAK"){
    drawLine(aux1, "rgba(109,124,255,.95)");
    drawLine(aux2, "rgba(255,211,110,.55)");
  } else if(preset.type==="RSI"){
    drawLine(aux1?.map(v=> v==null?null : (min + (max-min)*(v/100))), "rgba(109,124,255,.55)");
  } else if(preset.type==="MOM"){
    drawLine(aux1?.map(v=> v==null?null : (min + (max-min)*Math.max(0, Math.min(1, (v+0.2)/0.4)))), "rgba(109,124,255,.45)");
  }

  function drawLine(arr, stroke){
    if(!arr) return;
    ctx.strokeStyle=stroke;
    ctx.lineWidth=1.8;
    ctx.beginPath();
    let started=false;
    for(let i=0;i<=lastIndex;i++){
      const v=arr[i];
      if(v==null){ started=false; continue; }
      const x=xAt(i), y=yAt(v);
      if(!started){ ctx.moveTo(x,y); started=true; } else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  ctx.fillStyle="rgba(255,255,255,.65)";
  ctx.font="12px ui-sans-serif";
  for(let i=0;i<=4;i++){
    const v=max-(max-min)*i/4;
    const y=y0+(y1-y0)*i/4;
    ctx.fillText(v.toFixed(2), 10, y+4);
  }
  const pick=[0, Math.floor(n*0.33), Math.floor(n*0.66), lastIndex];
  for(const i of pick){
    const d = new Date(bars[i].t);
    const s = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    ctx.fillText(s, Math.max(xAt(i)-38, x0), H-18);
  }

  if(typeof playProgress==="number"){
    const x = xAt(lastIndex);
    ctx.strokeStyle="rgba(255,255,255,.18)";
    ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y1); ctx.stroke();
  }
}
function presetIsOverlayPrice(){
  const t = getPreset().type;
  return (t==="MA" || t==="BREAK");
}

function spinPreset(){
  const weights = PRESETS.map(p=>{
    if(p.type==="BREAK") return 1.25;
    if(p.type==="MA") return 1.05;
    if(p.type==="RSI") return 1.10;
    if(p.type==="MOM") return 0.95;
    return 1;
  });
  const sum = weights.reduce((a,b)=>a+b,0);
  let r = Math.random()*sum;
  let idx=0;
  for(let i=0;i<weights.length;i++){
    r -= weights[i];
    if(r<=0){ idx=i; break; }
  }
  els.preset.value = PRESETS[idx].id;
  updatePresetDesc();
  pulse("ğŸ² ë£°ë ›: " + PRESETS[idx].name);
}

function aiRecommend(){
  if(!STATE.bars.length){ spinPreset(); return; }
  const closes = STATE.bars.map(b=>b.close);
  let v=0, n=0;
  for(let i=1;i<closes.length;i++){
    const r = (closes[i]-closes[i-1])/closes[i-1];
    if(isFinite(r)){ v += Math.abs(r); n++; }
  }
  const vol = v/(n||1);
  const long = Math.min(240, closes.length-1);
  const tr = (closes[closes.length-1]-closes[closes.length-1-long])/closes[closes.length-1-long];

  let pick;
  if(vol > 0.018) pick = "MA_10_30";
  else if(tr > 0.25) pick = "BREAK_55";
  else if(tr > 0.08) pick = "MOM_120";
  else pick = "RSI_14_REV";
  els.preset.value = pick;
  updatePresetDesc();
  pulse("ğŸ¤– AI ì¶”ì²œ: " + getPreset().name);
}

function run(){
  if(!STATE.bars.length){ loadDemo(); }

  const cfg = { cash: Number(els.cash.value), fee: Number(els.fee.value), slip: Number(els.slip.value) };
  if(!isFinite(cfg.cash) || cfg.cash<=0) return alert("ì´ˆê¸°ìë³¸ì„ í™•ì¸í•´ì¤˜.");
  if(!isFinite(cfg.fee) || cfg.fee<0) cfg.fee=0;
  if(!isFinite(cfg.slip) || cfg.slip<0) cfg.slip=0;

  const preset = getPreset();
  const speed = els.speed.value;

  setProgress(0);
  clearLogs();
  toastKpiReset("ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘â€¦");

  if(speed === "SHOW"){
    let p=0;
    const id = setInterval(()=>{
      p += 0.05;
      setProgress(Math.min(100, p*100));
      drawChart(STATE.bars, null, null, Math.min(1,p));
      if(p>=1){ clearInterval(id); finalizeRun(cfg, preset); }
    }, 60);
  } else {
    let p=0;
    const id = setInterval(()=>{
      p += 0.20;
      setProgress(Math.min(100, p*100));
      if(p>=1){ clearInterval(id); finalizeRun(cfg, preset); }
    }, 60);
  }
}

function finalizeRun(cfg, preset){
  const res = runBacktest(STATE.bars, preset, cfg);
  STATE.result = res;
  STATE.equity = res.eq;
  STATE.trades = res.trades;

  els.kRet.textContent = fmtPct(res.ret);
  els.kMdd.textContent = fmtPct(-res.mdd);
  els.kTrades.textContent = String(res.tradeCount);
  els.kWin.textContent = (res.tradeCount>0 ? (res.winRate*100).toFixed(1)+"%" : "-");
  els.kGrade.innerHTML = gradeBadge(res.grade, res.score);

  renderLogs(res.trades);
  drawChart(STATE.bars, res.aux1, res.aux2, null);
  setProgress(100);

  updateBestToday(res);
  pulse(`${res.grade}  (${fmtPct(res.ret)} / MDD ${fmtPct(-res.mdd)})`);
}

function gradeBadge(grade, score){
  const g = String(grade||"TRY");
  let cls="badge";
  if(["LEGEND","GODMODE"].includes(g)) cls+=" gold";
  else if(["PRO","NICE","OK"].includes(g)) cls+=" good";
  else if(["RIP"].includes(g)) cls+=" bad";
  return `<span class="${cls}">${g}</span> <span class="tiny muted">score ${score.toFixed(1)}</span>`;
}

function updateBestToday(res){
  const best = loadBest();
  const cur = {
    day: TODAY,
    score: res.score,
    grade: res.grade,
    ret: res.ret,
    mdd: res.mdd,
    name: (els.sessionName.value || "ì„¸ì…˜").slice(0,60),
    preset: getPreset().name,
    at: Date.now()
  };
  let kept = best;
  if(!best || cur.score > best.score){ kept = cur; saveBest(cur); }
  STATE.bestToday = kept;
  els.kBest.textContent = kept ? `${kept.grade} (${(kept.score).toFixed(0)})` : "-";
}

function clearLogs(){ els.log.innerHTML = `<tr><td colspan="4" class="muted">ì§„í–‰ ì¤‘â€¦</td></tr>`; }
function renderLogs(trades){
  if(!trades?.length){
    els.log.innerHTML = `<tr><td colspan="4" class="muted">ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤(ì‹ í˜¸ ì—†ìŒ).</td></tr>`;
    return;
  }
  els.log.innerHTML = "";
  for(const t of trades.slice(-200)){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="font-family:ui-monospace;">${t.date}</td><td><b>${t.type}</b><div class="tiny muted">${t.reason||""}</div></td><td style="font-family:ui-monospace;">${Number(t.price).toFixed(2)}</td><td style="font-family:ui-monospace;">${fmtNum(t.equity)}</td>`;
    els.log.appendChild(tr);
  }
}

function exportTrades(){
  if(!STATE.result) return alert("ë¨¼ì € ì‹¤í–‰í•´ì¤˜.");
  const rows = [["date","type","price","equity","reason"]];
  for(const t of STATE.trades){ rows.push([t.date, t.type, String(t.price), String(t.equity), t.reason||""]); }
  const csv = rows.map(r => r.map(v=>{
    const s = String(v);
    return (s.includes(",") || s.includes('"') || s.includes("\n")) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(",")).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "trades.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 500);
}

function saveRecord(){
  if(!STATE.result) return alert("ë¨¼ì € ì‹¤í–‰í•´ì¤˜.");
  const key="qa_last_run_v1";
  const snap = {
    day: TODAY,
    at: Date.now(),
    name: els.sessionName.value || "ì„¸ì…˜",
    preset: getPreset(),
    result: {ret:STATE.result.ret, mdd:STATE.result.mdd, grade:STATE.result.grade, score:STATE.result.score},
  };
  localStorage.setItem(key, JSON.stringify(snap));
  pulse("ê¸°ë¡ ì €ì¥ë¨ âœ…");
}

function drawShare(){
  const c = els.shareCanvas;
  const ctx = c.getContext("2d");
  const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);

  const grad = ctx.createLinearGradient(0,0,W,H);
  grad.addColorStop(0, "rgba(109,124,255,.40)");
  grad.addColorStop(0.55, "rgba(53,240,181,.22)");
  grad.addColorStop(1, "rgba(255,211,110,.18)");
  ctx.fillStyle = "rgba(5,7,16,1)";
  ctx.fillRect(0,0,W,H);
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,W,H);

  roundRect(ctx, 60, 60, W-120, H-120, 36, "rgba(0,0,0,.55)", "rgba(255,255,255,.12)");

  ctx.fillStyle="rgba(255,255,255,.92)";
  ctx.font="900 54px ui-sans-serif";
  ctx.fillText("í€€íŠ¸ ì•„ì¼€ì´ë“œ", 110, 160);

  ctx.fillStyle="rgba(255,255,255,.72)";
  ctx.font="700 26px ui-sans-serif";
  ctx.fillText("ê²Œì„í˜• ë°±í…ŒìŠ¤í„° ê²°ê³¼", 110, 205);

  const name = (els.sessionName.value || "ì„¸ì…˜").slice(0,40);
  ctx.fillStyle="rgba(255,255,255,.86)";
  ctx.font="800 34px ui-sans-serif";
  ctx.fillText(name, 110, 275);

  if(!STATE.result){
    ctx.fillStyle="rgba(255,255,255,.70)";
    ctx.font="700 24px ui-sans-serif";
    ctx.fillText("ì•„ì§ ê²°ê³¼ê°€ ì—†ì–´ìš”. ğŸš€ ë°±í…ŒìŠ¤íŠ¸ í›„ ë‹¤ì‹œ ì—´ì–´ì¤˜!", 110, 340);
    return;
  }

  const g = STATE.result.grade;
  const ret = fmtPct(STATE.result.ret);
  const mdd = fmtPct(-STATE.result.mdd);
  const presetName = getPreset().name;

  let badge = "rgba(255,255,255,.14)";
  let badgeText = "rgba(255,255,255,.92)";
  if(["LEGEND","GODMODE"].includes(g)) badge="rgba(255,211,110,.22)";
  else if(["PRO","NICE","OK"].includes(g)) badge="rgba(53,240,181,.18)";
  else if(["RIP"].includes(g)) badge="rgba(255,91,122,.18)";

  roundRect(ctx, 110, 310, 260, 62, 999, badge, "rgba(255,255,255,.12)");
  ctx.fillStyle=badgeText;
  ctx.font="900 30px ui-sans-serif";
  ctx.fillText(g, 150, 352);

  ctx.fillStyle="rgba(255,255,255,.86)";
  ctx.font="900 46px ui-sans-serif";
  ctx.fillText(ret, 110, 430);

  ctx.fillStyle="rgba(255,255,255,.72)";
  ctx.font="800 22px ui-sans-serif";
  ctx.fillText(`MDD ${mdd}  Â·  ${presetName}`, 110, 470);

  ctx.fillStyle="rgba(255,255,255,.62)";
  ctx.font="700 18px ui-sans-serif";
  ctx.fillText("data processed locally Â· not investment advice", 110, 540);

  if(STATE.bars?.length){
    const closes = STATE.bars.map(b=>b.close);
    const x0=650, y0=220, w=470, h=260;
    roundRect(ctx, x0, y0, w, h, 26, "rgba(255,255,255,.06)", "rgba(255,255,255,.10)");
    let min=Math.min(...closes), max=Math.max(...closes);
    const pad=(max-min)*0.08 || 1; min-=pad; max+=pad;

    ctx.strokeStyle="rgba(53,240,181,.90)";
    ctx.lineWidth=3;
    ctx.beginPath();
    for(let i=0;i<closes.length;i++){
      const x = x0+24 + (w-48) * (i/(closes.length-1));
      const y = y0+h-24 - (h-48) * ((closes[i]-min)/(max-min));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }
}
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  if(fill){ ctx.fillStyle=fill; ctx.fill(); }
  if(stroke){ ctx.strokeStyle=stroke; ctx.lineWidth=2; ctx.stroke(); }
}
function downloadShare(){
  drawShare();
  const c = els.shareCanvas;
  const a = document.createElement("a");
  a.href = c.toDataURL("image/png");
  a.download = "quant-arcade-share.png";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function setProgress(p){ els.prog.style.width = `${Math.max(0, Math.min(100, p))}%`; }
function pulse(msg){
  els.kGrade.insertAdjacentHTML("beforeend", `<div class="tiny muted" style="margin-top:6px;">${escapeHtml(msg)}</div>`);
  setTimeout(()=> {
    const tiny = els.kGrade.querySelector(".tiny.muted");
    if(tiny) tiny.remove();
  }, 1800);
}
function toastKpiReset(status){
  els.kGrade.textContent = "-";
  els.kRet.textContent = "-";
  els.kMdd.textContent = "-";
  els.kTrades.textContent = "-";
  els.kWin.textContent = "-";
  setProgress(0);
  els.log.innerHTML = `<tr><td colspan="4" class="muted">${escapeHtml(status || "ì¤€ë¹„ë¨")}</td></tr>`;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

els.btnHow.addEventListener("click", ()=> showModal(els.mHow));
els.btnShare.addEventListener("click", ()=> { drawShare(); showModal(els.mShare); });
els.btnCopyShare.addEventListener("click", downloadShare);

$$("[data-close]").forEach(b=>{ b.addEventListener("click", ()=> hideModal($(b.getAttribute("data-close")))); });
function showModal(m){ m.classList.add("show"); }
function hideModal(m){ m.classList.remove("show"); }

els.mode.addEventListener("change", renderInputArea);

els.btnDemo.addEventListener("click", ()=>{ els.mode.value = "DEMO"; renderInputArea(); loadDemo(); });
els.btnSpin.addEventListener("click", spinPreset);
els.btnAI.addEventListener("click", aiRecommend);
els.btnRun.addEventListener("click", run);
els.btnSave.addEventListener("click", saveRecord);
els.btnExport.addEventListener("click", exportTrades);

els.preset.addEventListener("change", updatePresetDesc);

els.btnReset.addEventListener("click", ()=>{
  if(!confirm("ë¡œì»¬ ìºì‹œ/ê¸°ë¡ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  wipeAll();
  STATE = {bars:[],equity:[],trades:[],result:null,lastStrategy:null,bestToday:null};
  els.sessionName.value="";
  toastKpiReset("ì´ˆê¸°í™” ì™„ë£Œ");
  drawChart([], null, null, null);
});

document.addEventListener("keydown", (e)=>{ if(e.key==="Escape"){ hideModal(els.mHow); hideModal(els.mShare); } });

function init(){
  setPresets();
  renderInputArea();

  const best = loadBest();
  if(best){ STATE.bestToday = best; els.kBest.textContent = `${best.grade} (${best.score.toFixed(0)})`; }
  else { els.kBest.textContent = "-"; }

  loadDemo();
}
init();
</script>
</body>
</html>
